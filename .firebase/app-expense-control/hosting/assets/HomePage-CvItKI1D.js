import{r as p,U as ue,u as pe,c as R,d as L,o as q,j as e,S as xe,N as T,I as f,a as ge,s as he,b as fe,g as ye,e as be,f as je,h as we}from"./index-DE57Cpbo.js";import{u as Ne}from"./useAuthRequired-KSE0LA4s.js";import{P as U,C as ve,A as De,p as Ce,a as Fe,b as Se,L as ke,c as $e,d as Me,e as Te,B as Ae}from"./index-B3sN4ZPE.js";import{x as Ie}from"./x_male_female_purple-CymKkZ1r.js";ve.register(De,Ce,Fe,Se,ke,$e,Me,Te,Ae);function Oe(){const{isAuthenticated:J}=Ne("/register","/"),{loading:D,userAuth:h,userData:t,state:a,setState:x}=p.useContext(ue),[y,Y]=p.useState(0),[H,W]=p.useState([]),[Z,K]=p.useState([]),[Q,ee]=p.useState([]),[A,te]=p.useState([]),[ae,se]=p.useState(0),[B,ne]=p.useState({}),[P,re]=p.useState({}),[b,V]=p.useState(!1),le=t&&(t==null?void 0:t.profilePhoto)||"",oe=pe().pathname;p.useEffect(()=>{var M;if(!t||!a.gastos||!a.ingresos||D)return;const s=parseInt((M=t==null?void 0:t.expenseControl)==null?void 0:M.cutoffDay,10)||12,n=new Date,m=n.getDate(),u=n.getMonth(),g=n.getFullYear(),i=new Date(g,u-(m<s?1:0),s),o=new Date(i.getFullYear(),i.getMonth()+1,s-1,23,59,59),N=a.gastos.filter(r=>{const l=r.createdAt instanceof Date?r.createdAt:r.createdAt.toDate();return l>=i&&l<=o}),I=N.reduce((r,l)=>(r[l.type]||(r[l.type]=0),r[l.type]+=parseFloat(l.gasto)||0,r),{}),v=N.reduce((r,l)=>(r[l.category]||(r[l.category]=0),r[l.category]+=parseFloat(l.gasto)||0,r),{}),k=Object.keys(I),c=Object.values(I),w=Object.keys(v),$=Object.values(v),E={labels:k,datasets:[{label:"Gastos por Tipo de Pago",data:c,backgroundColor:["#495867","#495867","#495867","#495867","#495867"],borderColor:"#fff",borderWidth:1}]};K(c),ee(k),te(E),W(N),Y(N.reduce((r,l)=>r+(parseFloat(l.gasto)||0),0)),re({labels:w,datasets:[{label:"Gastos por Categoría",data:$,backgroundColor:["#D3D6DB","#D3D6DB","#D3D6DB","#D3D6DB","#D3D6DB"],borderColor:"#fff",borderWidth:1}]});const d=a.ingresos.reduce((r,l)=>(r[l.category]||(r[l.category]=0),r[l.category]+=parseFloat(l.ingreso)||0,r),{}),O=Object.keys(d),G=Object.values(d);ne({labels:O,datasets:[{label:"Ingresos por Categoría",data:G,backgroundColor:["#D3D6DB","#D3D6DB","#D3D6DB","#D3D6DB","#D3D6DB"],borderColor:"#fff",borderWidth:1}]});const X=a.ingresos.filter(r=>{const l=r.createdAt instanceof Date?r.createdAt:r.createdAt.toDate();return l>=i&&l<=o});se(X.reduce((r,l)=>r+(parseFloat(l.ingreso)||0),0))},[a.gastos,a.ingresos,t,D]),p.useEffect(()=>(a.isModalOpen?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[a.isModalOpen]),p.useEffect(()=>{if(h&&h.username){const s=R(L,"userPosts",h.username,"gastos"),n=R(L,"userPosts",h.username,"ingresos"),m=q(s,g=>{const i=g.docs.map(o=>({id:o.id,...o.data(),createdAt:o.data().createdAt.toDate()}));x(o=>({...o,gastos:i,loading:!1}))}),u=q(n,g=>{const i=g.docs.map(o=>({id:o.id,...o.data(),createdAt:o.data().createdAt.toDate()}));x(o=>({...o,ingresos:i,loading:!1}))});return()=>{m(),u()}}},[h]);const _=()=>x(s=>({...s,isModalOpen:!0})),ie=()=>x(s=>({...s,isModalOpen:!1})),ce=s=>{const n=s.replace(/[^0-9]/g,"");return n.length===0?"":(parseFloat(n)/100).toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})},j=s=>{const{name:n,type:m,value:u,files:g}=s.target;if(m==="file")x(i=>({...i,[n]:g[0]}));else{const i=n==="gasto"||n==="ingreso"?ce(u):u;x(o=>({...o,[n]:i}))}},de=s=>{const{name:n}=s.target,m=a[n].replace(/[^0-9]/g,""),u=m.length===0?"":parseFloat(m)/100;x(g=>({...g,[n]:u.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}))},me=async(s,n=!1)=>{var k;s.preventDefault(),x(c=>({...c,isSubmitting:!0}));const m=parseFloat((a[n?"ingreso":"gasto"]||"").toString().replace(/[^0-9.-]+/g,""));if(isNaN(m)||m<=0){x(c=>({...c,error:`Por favor, ingresa un ${n?"ingreso":"gasto"} válido.`,isSubmitting:!1})),console.log("ingreso");return}const u=a.date?new Date(a.date+"T00:00:00"):new Date,g=u.getFullYear(),i=u.getMonth(),o=u.getDate(),N=(t==null?void 0:t.expenseControl.cutoffDay)||1,I=String(g);let v="";o<N?v=["diciembreEnero","eneroFebrero","febreroMarzo","marzoAbril","abrilMayo","mayoJunio","junioJulio","julioAgosto","agostoSeptiembre","septiembreOctubre","octubreNoviembre","noviembreDiciembre"][i]||"desconocido":v=["eneroFebrero","febreroMarzo","marzoAbril","abrilMayo","mayoJunio","junioJulio","julioAgosto","agostoSeptiembre","septiembreOctubre","octubreNoviembre","noviembreDiciembre","diciembreEnero"][i]||"desconocido";try{let c=a.fileURL,w;if(a.file){const d=new Date,O=`${String(d.getFullYear()).slice(2)}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`,G=`${String(d.getHours()).padStart(2,"0")}${String(d.getMinutes()).padStart(2,"0")}${String(d.getSeconds()).padStart(2,"0")}`,X=a.file.name.replace(/[^a-zA-Z0-9.]/g,"_");w=`IMG_${O}-EC${G}.${X.split(".").pop()}`;const M=ge(he,`userFiles/${h.username}/${w}`);try{await fe(M,a.file),c=await ye(M)}catch{throw new Error("No se pudo subir el archivo.")}}const $={[n?"ingreso":"gasto"]:m,title:a.title,remarks:a.remarks,type:a.type,category:a.category,user:h.username,createdAt:u,year:I,period:v};c&&($.image={imageURL:c,name:w||((k=a.file)==null?void 0:k.name)||""});const E=n?"ingresos":"gastos";if(a.currentId){const d=be(L,"userPosts",h.username,E,String(a.currentId));await je(d,$)}else{const d=R(L,"userPosts",h.username,E);await we(d,$)}x(d=>({...d,[n?"ingreso":"gasto"]:"",title:"",remarks:"",category:"",type:"",file:null,isModalOpen:!1,error:"",currentId:null}))}catch(c){console.error(`Error al guardar el ${n?"ingreso":"gasto"}: `,c),x(w=>({...w,error:`Error al guardar los datos: ${c.message}`,isSubmitting:!1}))}finally{x(c=>({...c,isSubmitting:!1}))}},C=!D&&t&&t.expenseControl&&t.expenseControl.budget,F=!D&&t&&t.expenseControl&&t.expenseControl.budget-y,S=F*100/C,z=y*100/C;return a.loading?e.jsx(xe,{}):J?e.jsxs("div",{className:"mb-10",children:[e.jsx("section",{className:"w-full max-w-screen-sm flex items-center justify-end",children:e.jsx(T,{to:!oe.includes("profile")&&"profile",children:e.jsx("img",{src:le||Ie,alt:"Profile",className:"w-12 h-12 rounded-full object-cover border"})})}),e.jsxs("section",{className:"w-full max-w-screen-sm py-3 flex flex-col items-center",children:[e.jsx("p",{className:"leading-3 text-main-dark/50",children:"Gastos Totales"}),e.jsxs("h1",{className:"text-4xl font-bold text-main-dark my-1",children:["$",y.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("p",{className:` ${C-y<0?"text-main-primary":"text-main-highlight"}`,children:new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(C-y.toFixed(2))})]}),e.jsxs("section",{className:"w-full max-w-screen-sm flex justify-between items-center gap-2 py-3",children:[e.jsxs("button",{onClick:()=>{V(!1),_()},className:"w-full flex-center gap-1 text-sm font-semibold bg-primary-nightshade/70 text-white rounded-3xl p-3 transition-colors duration-200 hover:bg-primary-nightshade",children:[e.jsx("i",{className:"flex-center w-6 h-6 rounded-full hover:scale-105",children:f.plus.fill("#FFFFFF")}),"Agregar Gasto"]}),e.jsxs("button",{onClick:()=>{V(!0),_()},className:"w-full flex-center gap-1 text-sm font-semibold bg-main-highlight/70 text-white rounded-3xl p-3 transition-colors duration-200 hover:bg-main-highlight",children:[e.jsx("i",{className:"flex-center w-6 h-6 rounded-full hover:scale-105",children:f.plus.fill("#FFFFFF")}),"Agregar Ingreso"]})]}),H.length>0&&e.jsxs("section",{className:"w-full max-w-screen-sm py-3",children:[e.jsx("h2",{className:"text-main-dark text-lg font-semibold mb-3",children:"Resumen Mensual"}),e.jsxs(T,{to:"/expenses/all",className:"w-full flex gap-[4%] h-full rounded-3xl mb-3 bg-white",children:[e.jsxs("div",{className:"w-[48%] h-[130px] py-3 px-4 flex flex-col justify-between",children:[e.jsxs("p",{className:"w-full text-main-primary text-center flex gap-1 font-bold",children:[e.jsx("i",{className:"flex-center w-5 h-5 aspect-square",children:f.flame.fill("#C2185B")}),"Gastos"]}),e.jsxs("p",{className:`w-full font-semibold text-2xl mt-7 ${z>100&&"text-primary-nightshade"}`,children:[` ${z.toFixed(0)}% `,e.jsx("span",{className:"text-xs ml-1 text-primary-slate/70",children:"gastado"})]})]}),e.jsx("div",{className:"w-[48%] h-[130px] max-h-[130px] p-4 rounded-3xl flex flex-col items-start",children:e.jsx("div",{className:"flex-grow flex-center w-full h-full pl-12",children:e.jsx(U,{data:P,options:{cutout:"55%",plugins:{tooltip:{callbacks:{label:s=>`${P.labels[s.dataIndex]}: $${P.datasets[0].data[s.dataIndex].toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}`}},legend:{display:!1}}}})})})]}),e.jsxs(T,{to:"/incomes",className:"w-full flex gap-[4%] h-full rounded-3xl mb-3 bg-white",children:[e.jsxs("div",{className:"w-[48%] h-[130px] py-3 px-4 flex flex-col justify-between",children:[e.jsxs("p",{className:"w-full text-main-highlight/70 text-center flex gap-1 font-bold",children:[e.jsx("i",{className:"flex-center w-6 h-6",children:f.money.wings()}),"Ingresos"]}),e.jsxs("p",{className:"w-full font-semibold text-2xl mt-7",children:[`$${ae.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}`,e.jsx("span",{className:"text-xs text-primary-slate/70",children:" ganados"})]})]}),e.jsx("div",{className:"w-[48%] h-[130px] max-h-[130px] p-4 rounded-3xl flex flex-col items-start",children:e.jsx("div",{className:"flex-grow flex-center w-full h-full pl-12",children:e.jsx(U,{data:B,options:{cutout:"55%",plugins:{tooltip:{callbacks:{label:s=>`${B.labels[s.dataIndex]}: $${B.datasets[0].data[s.dataIndex].toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}`}},legend:{display:!1}}}})})})]}),e.jsxs("aside",{className:"w-full flex flex-wrap items-stretch gap-[4%]",children:[e.jsxs("div",{className:`flex flex-col bg-white rounded-3xl py-3 px-4 ${S<0?" hidden ":" w-[48%] max-w-[300px]"}`,children:[e.jsx("span",{className:"font-light text-xs text-primary-slate",children:"Presupuesto Libre"}),e.jsxs("span",{className:"font-semibold text-xl text-main-dark",children:[" ",new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(C-y)]})]}),e.jsxs(T,{to:"/expenses/gastos",className:`flex flex-col bg-white rounded-3xl py-3 px-4 ${S<0?" items-start w-full":" w-[48%] max-w-[300px]"}`,children:[e.jsx("span",{className:"font-light text-xs text-primary-slate",children:"Gastos Totales"}),e.jsxs("span",{className:"font-semibold text-xl text-main-dark",children:["$",y.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]})]})]}),F<0&&e.jsxs("aside",{className:"w-full flex flex-wrap items-stretch gap-[4%] mt-3",children:[e.jsxs("div",{className:`${F<0?"bg-primary-platinum":"bg-white hidden"} ${S<0?"w-[48%] max-w-[300px]":"w-full"} rounded-3xl p-4 flex justify-between items-center`,children:[e.jsx("span",{className:"text-main-dark",children:"Saldo"}),e.jsx("span",{className:`${F<0?"text-main-primary":"text-main-highlight"} font-semibold`,children:new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(F)})]}),S<0&&e.jsxs("div",{className:"w-[48%] max-w-[300px] bg-primary-platinum rounded-3xl p-4 flex items-center justify-between gap-1 opacity-0 transform scale-95 transition-all duration-500 ease-out motion-safe:animate-fade-in",children:[e.jsx("i",{className:"flex-center w-6 h-6",children:f.alert.border("#C2185B")}),e.jsxs("span",{className:"text-sm text-main-primary",children:["Has gastado",e.jsx("span",{className:"text-base font-semibold text-main-primary",children:` ${S.toFixed(2)}% `}),"más de lo que deberías este mes."]})]})]}),e.jsx("aside",{className:"w-full flex flex-wrap items-start gap-[4%] my-3",children:Q.map((s,n)=>e.jsx(T,{to:"/expenses/payments",className:"w-[48%] max-w-[300px] mb-3",children:e.jsx("div",{className:"bg-white py-3 px-4 rounded-3xl h-full flex flex-col items-start",children:e.jsxs("div",{className:"flex-grow flex gap-4 w-full",children:[e.jsxs("p",{className:"flex flex-col items-start w-full",children:[e.jsxs("span",{className:"text-xs font-light capitalize text-main-dark",style:{color:A.datasets[0].backgroundColor[n]},children:[s==="card1"&&t.paymentTypes.card1,s==="card2"&&t.paymentTypes.card2,s==="card3"&&t.paymentTypes.card3,s==="card4"&&t.paymentTypes.card4,s==="card5"&&t.paymentTypes.card5,s==="other"&&t.paymentTypes.other,s==="cash"&&"Efectivo"]}),e.jsxs("span",{className:"text-xl font-semibold text-main-dark",children:["$",Z[n].toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsx("i",{className:"flex-center w-9 h-9",children:s==="cash"&&f.money.border(A.datasets[0].backgroundColor[n])||s==="other"&&f.bitcoin.border(A.datasets[0].backgroundColor[n])||f.credit_card.border(A.datasets[0].backgroundColor[n])})]})})},s))})]}),a.isModalOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full h-[85vh] relative overflow-hidden",children:e.jsxs("form",{onSubmit:s=>me(s,b),className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:ie,className:"p-2 text-main-primary",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:a.isSubmitting,className:"p-2 text-main-highlight rounded hover:bg-main-primary-dark transition",children:a.isSubmitting?"Guardando...":a.currentGastoId?"Actualizar":"Agregar"})]}),e.jsxs("div",{className:"px-2",children:[e.jsxs("hgroup",{className:"rounded-3xl py-2 px-4 mb-4 bg-main-light",children:[e.jsx("input",{name:"title",type:"text",placeholder:b?"Concepto del ingreso":"Concepto del gasto",value:a.title,onChange:j,className:"w-full py-2 bg-transparent outline-none border-b border-main-dark/20 text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsxs("div",{className:"flex-center pt-2 py-2",children:["$",e.jsx("input",{name:b?"ingreso":"gasto",type:"text",placeholder:`$ $ ${b?"Ingreso":"Gasto"}`,value:a[b?"ingreso":"gasto"],onChange:j,onBlur:de,className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),!D&&t&&t.expenseControl&&(t==null?void 0:t.expenseControl.currency)]})]}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("select",{name:"type",value:a.type,onChange:j,className:"w-full bg-transparent outline-none",required:!0,children:b?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),t.incomeControl.paymentTypes.type1&&e.jsx("option",{value:"type1",children:t.incomeControl.paymentTypes.type1}),t.incomeControl.paymentTypes.type2&&e.jsx("option",{value:"type2",children:t.incomeControl.paymentTypes.type2}),t.incomeControl.paymentTypes.type3&&e.jsx("option",{value:"type3",children:t.incomeControl.paymentTypes.type3}),t.incomeControl.paymentTypes.type4&&e.jsx("option",{value:"type4",children:t.incomeControl.paymentTypes.type4}),t.incomeControl.paymentTypes.type5&&e.jsx("option",{value:"type5",children:t.incomeControl.paymentTypes.type5}),t.incomeControl.paymentTypes.other&&e.jsx("option",{value:"other",children:t.incomeControl.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]}):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),t.paymentTypes.card1&&e.jsx("option",{value:"card1",children:t.paymentTypes.card1}),t.paymentTypes.card2&&e.jsx("option",{value:"card2",children:t.paymentTypes.card2}),t.paymentTypes.card3&&e.jsx("option",{value:"card3",children:t.paymentTypes.card3}),t.paymentTypes.card4&&e.jsx("option",{value:"card4",children:t.paymentTypes.card4}),t.paymentTypes.card5&&e.jsx("option",{value:"card5",children:t.paymentTypes.card5}),t.paymentTypes.other&&e.jsx("option",{value:"other",children:t.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]})})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"category",value:a.category,onChange:j,className:"w-full bg-transparent outline-none",required:!0,children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Categorías"}),b?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"salary",children:"Salario"}),e.jsx("option",{value:"business",children:"Negocios"}),e.jsx("option",{value:"investment",children:"Inversiones"}),e.jsx("option",{value:"other",children:"Otros Ingresos"})]}):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"feeding",children:"Alimentación y Bebidas"}),e.jsx("option",{value:"transportation",children:"Transporte"}),e.jsx("option",{value:"health",children:"Salud y Bienestar"}),e.jsx("option",{value:"educationJob",children:"Educación o Trabajo"}),e.jsx("option",{value:"housing",children:"Vivienda"}),e.jsx("option",{value:"entertainment",children:"Entretenimiento y Ocio"}),e.jsx("option",{value:"personalCare",children:"Ropa y Cuidado Personal"})]})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{id:"date",name:"date",type:"date",value:a.date,onChange:j,className:"w-full bg-transparent outline-none text-main-dark placeholder:text-main-dark/50"})}),!a.currentGastoId&&e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{name:"file",type:"file",onChange:j,className:"w-full",accept:"image/*, .pdf"})}),e.jsx("textarea",{name:"remarks",placeholder:"Observaciones",value:a.remarks,onChange:j,rows:"4",className:"w-full rounded-3xl p-4 mb-4 outline-none bg-main-light"})]})]})})})]}):null}export{Oe as default};
