import{r as x,U as J,j as e,S as A,I as D,d as N,b as v,h as q,a as E,s as F,i as Y,k as X,u as _,g as H,c as K,e as Q,f as W}from"./index-pNOXhOLA.js";import{u as Z}from"./useAuthRequired-CMkwRkcB.js";import{F as ee,S as ae}from"./Button-CGduoOyj.js";function ne(){const{isLoading:M,isAuthenticated:R}=Z("/register","/transactions"),{loading:k,userAuth:g,userData:o,state:t,setState:u}=x.useContext(J),[C,I]=x.useState(null),[y,S]=x.useState("");x.useEffect(()=>{var j;if(!o||!t.gastos||k)return;const a=parseInt((j=o==null?void 0:o.expenseControl)==null?void 0:j.cutoffDay,10)||12,r=new Date,l=r.getDate(),s=r.getMonth(),c=r.getFullYear(),d=new Date(c,s-(l<a?1:0),a),m=new Date(d.getFullYear(),d.getMonth()+1,a-1,23,59,59);t.gastos.filter(n=>{const i=n.createdAt instanceof Date?n.createdAt:n.createdAt.toDate();return i>=d&&i<=m})},[t.gastos,o,k]),x.useEffect(()=>(t.isModalOpen?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[t.isModalOpen]);const w=t.gastos.filter(a=>a.title.toLowerCase().includes(y.toLowerCase())||a.remarks.toLowerCase().includes(y.toLowerCase())||a.category.toLowerCase().includes(y.toLowerCase())).sort((a,r)=>r.createdAt-a.createdAt),p=a=>{const r=a.target.value;r!==void 0&&S(r)},L=[{slug:p,label:"Todos",anchor:""},{slug:p,label:"Alimentación y Bebidas",anchor:"feeding"},{slug:p,label:"Transporte",anchor:"transportation"},{slug:p,label:"Salud y Bienestar",anchor:"health"},{slug:p,label:"Gastos de Educación o Trabajo",anchor:"educationJob"},{slug:p,label:"Vivienda",anchor:"housing"},{slug:p,label:"Entretenimiento y Ocio",anchor:"entertainment"},{slug:p,label:"Ropa y Cuidado Personal",anchor:"personalCare"}],G=a=>{I(C===a?null:a)},O=async a=>{try{const r=N(v,"userPosts",g.username,"gastos",a),l=await q(r);if(l.exists()){const s=l.data();u(c=>({...c,gasto:(s==null?void 0:s.gasto)||"",title:(s==null?void 0:s.title)||"",remarks:(s==null?void 0:s.remarks)||"",category:(s==null?void 0:s.category)||"",type:(s==null?void 0:s.type)||"",date:s!=null&&s.createdAt?s.createdAt.toDate().toISOString().substring(0,10):"",fileURL:(s==null?void 0:s.fileURL)||"",isModalOpen:!0,currentGastoId:a}))}else console.error(`El gasto con ID: ${a} no existe.`)}catch(r){console.error("Error al obtener los datos del gasto:",r)}},$=async(a,r,l)=>{if(window.confirm(`¿Estás seguro de que deseas eliminar el gasto "${r.title}" de $${r.gasto}?`))try{const c=N(v,"userPosts",g.username,"gastos",a);if(l&&l.trim()!==""){const d=E(F,`userFiles/${g.username}/${l}`);try{await Y(d),console.log("Imagen asociada eliminada de Storage.")}catch(m){console.error("Error al eliminar la imagen de Storage: ",m)}}else console.log("No se proporcionó una imagen para eliminar.");await X(c),console.log("Gasto eliminado correctamente."),u(d=>({...d,gastos:d.gastos.filter(m=>m.id!==a)}))}catch(c){console.error("Error al eliminar el gasto: ",c),alert("No se pudo eliminar el gasto. Intenta nuevamente.")}},B=()=>u(a=>({...a,isModalOpen:!1})),P=a=>{const r=a.replace(/[^0-9]/g,"");return r.length===0?"":(parseFloat(r)/100).toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})},h=a=>{const{name:r,type:l,value:s,files:c}=a.target;if(l==="file")u(d=>({...d,[r]:c[0]}));else{const d=r==="gasto"?P(s):s;u(m=>({...m,[r]:d}))}},V=a=>{const{name:r}=a.target,l=t[r].replace(/[^0-9]/g,""),s=l.length===0?"":parseFloat(l)/100;u(c=>({...c,[r]:s.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}))},U=async a=>{a.preventDefault(),u(i=>({...i,isSubmitting:!0}));const r=parseFloat((t.gasto||"").toString().replace(/[^0-9.-]+/g,""));if(isNaN(r)||r<=0){u(i=>({...i,error:"Por favor, ingresa un gasto válido.",isSubmitting:!1}));return}const l=t.date?new Date(t.date+"T00:00:00"):new Date,s=l.getFullYear(),c=l.getMonth(),d=l.getDate(),m=(o==null?void 0:o.expenseControl.cutoffDay)||1,j=String(s);let n="";if(d<m)switch(c){case 0:n="diciembreEnero";break;case 1:n="eneroFebrero";break;case 2:n="febreroMarzo";break;case 3:n="marzoAbril";break;case 4:n="abrilMayo";break;case 5:n="mayoJunio";break;case 6:n="junioJulio";break;case 7:n="julioAgosto";break;case 8:n="agostoSeptiembre";break;case 9:n="septiembreOctubre";break;case 10:n="octubreNoviembre";break;case 11:n="noviembreDiciembre";break;default:n="desconocido"}else switch(c){case 0:n="eneroFebrero";break;case 1:n="febreroMarzo";break;case 2:n="marzoAbril";break;case 3:n="abrilMayo";break;case 4:n="mayoJunio";break;case 5:n="junioJulio";break;case 6:n="julioAgosto";break;case 7:n="agostoSeptiembre";break;case 8:n="septiembreOctubre";break;case 9:n="octubreNoviembre";break;case 10:n="noviembreDiciembre";break;case 11:n="diciembreEnero";break;default:n="desconocido"}try{let i=t.fileURL;if(t.file){const b=Date.now(),z=`${t.title}_${b}.${t.file.name.split(".").pop()}`,T=E(F,`userFiles/${g.username}/${z}`);await _(T,t.file),i=await H(T)}const f={gasto:r,title:t.title,remarks:t.remarks,type:t.type,category:t.category,user:g.username,createdAt:l,year:j,period:n};if(i&&(f.fileURL=i),t.currentGastoId){const b=N(v,"userPosts",g.username,"gastos",String(t.currentGastoId));await K(b,f)}else{const b=Q(v,"userPosts",g.username,"gastos");await W(b,f)}u(b=>({...b,gasto:"",title:"",remarks:"",category:"",type:"",file:null,isModalOpen:!1,error:"",currentGastoId:null})),setTimeout(()=>location.reload(),1e3)}catch(i){console.error("Error al subir datos: ",i),u(f=>({...f,error:"Error al subir los datos: "+i.message,isSubmitting:!1}))}finally{u(i=>({...i,isSubmitting:!1}))}};return M?e.jsx(A,{bgTheme:!0}):R?e.jsxs("div",{children:[e.jsx("section",{className:"w-full max-w-screen-sm mt-6 py-3 flex flex-col items-center",children:e.jsx("p",{className:"text-main-dark/50",children:"Transacciones"})}),e.jsx("section",{className:"relative py-2 mb-2 flex items-center",children:e.jsxs("div",{className:"w-full flex-center pl-4 rounded-3xl bg-main-dark/5",children:[e.jsx("i",{className:"flex-center w-6 h-6 opacity-40",children:D.search.border("#1C1C1E")}),e.jsx("input",{type:"text",placeholder:"Filtrar gastos...",value:y,onChange:a=>S(a.target.value),className:"w-full h-full pl-1 py-4 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsx(ee,{label:e.jsx("i",{className:"flex-center w-6 h-6",children:D.filter.fill("#C2185B")}),items:L})]})}),e.jsxs("section",{className:"w-full max-w-screen-sm mb-20",children:[e.jsxs("hgroup",{className:"mb-2",children:[e.jsx("h2",{className:"text-main-dark py-2 text-lg font-semibold border-b border-main-dark/20",children:"Gastos"}),e.jsxs("p",{className:"py-2 text-sm font-light text-main-dark/50",children:[w.length," Resultados"]})]}),e.jsx("ul",{className:"space-y-3",children:t.loading?e.jsx(A,{bgTheme:!0}):w.length>0?w.sort((a,r)=>{const l=a.createdAt instanceof Date?a.createdAt:a.createdAt.toDate();return(r.createdAt instanceof Date?r.createdAt:r.createdAt.toDate()).getTime()-l.getTime()}).map(a=>e.jsx(ae,{context:o,data:a,onEdit:()=>O(a.id),onDelete:()=>$(a.id,a,a.image&&a.image.name),expandedGastoId:C,onCardClick:G},a.id)):e.jsx("li",{className:"flex justify-between items-center bg-main-dark/5 rounded-3xl p-4",children:e.jsx("span",{className:"text-main-dark font-medium",children:"No hay gastos registrados"})})})]}),t.isModalOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full h-[85vh] relative overflow-hidden",children:e.jsxs("form",{onSubmit:U,className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:B,className:"p-2 text-main-primary",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:t.isSubmitting,className:"p-2 text-main-highlight rounded hover:bg-main-primary-dark transition",children:t.isSubmitting?"Guardando...":t.currentGastoId?"Actualizar":"Agregar"})]}),e.jsxs("div",{className:"px-2",children:[e.jsxs("hgroup",{className:"rounded-3xl py-2 px-4 mb-4 bg-main-light",children:[e.jsx("input",{name:"title",type:"text",placeholder:"Concepto",value:t.title,onChange:h,className:"w-full py-2 bg-transparent outline-none border-b border-main-dark/20 text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsxs("div",{className:"flex-center pt-2 py-2",children:["$",e.jsx("input",{name:"gasto",type:"text",placeholder:"$ $",value:t.gasto,onChange:h,onBlur:V,className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),!k&&(o==null?void 0:o.expenseControl.currency)]})]}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"type",value:t.type,onChange:h,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),o.paymentTypes.card1&&e.jsx("option",{value:"card1",children:o.paymentTypes.card1}),o.paymentTypes.card2&&e.jsx("option",{value:"card2",children:o.paymentTypes.card2}),o.paymentTypes.card3&&e.jsx("option",{value:"card3",children:o.paymentTypes.card3}),o.paymentTypes.card4&&e.jsx("option",{value:"card4",children:o.paymentTypes.card4}),o.paymentTypes.card5&&e.jsx("option",{value:"card5",children:o.paymentTypes.card5}),o.paymentTypes.other&&e.jsx("option",{value:"other",children:o.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"category",value:t.category,onChange:h,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Categorías"}),e.jsx("option",{value:"feeding",children:"Alimentación y Bebidas"}),e.jsx("option",{value:"transportation",children:"Transporte"}),e.jsx("option",{value:"health",children:"Salud y Bienestar"}),e.jsx("option",{value:"educationJob",children:"Gastos de Educación o Trabajo"}),e.jsx("option",{value:"housing",children:"Vivienda"}),e.jsx("option",{value:"entertainment",children:"Entretenimiento y Ocio"}),e.jsx("option",{value:"personalCare",children:"Ropa y Cuidado Personal"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{id:"date",name:"date",type:"date",value:t.date,onChange:h,className:"w-full bg-transparent outline-none text-main-dark placeholder:text-main-dark/50"})}),!t.currentGastoId&&e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{name:"file",type:"file",onChange:h,className:"w-full",accept:"image/*, .pdf"})}),e.jsx("textarea",{name:"remarks",placeholder:"Observaciones",value:t.remarks,onChange:h,rows:"4",className:"w-full rounded-3xl p-4 mb-4 outline-none bg-main-light"})]})]})})})]}):null}export{ne as default};
