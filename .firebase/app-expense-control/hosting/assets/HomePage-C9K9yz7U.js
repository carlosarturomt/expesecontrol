import{r as y,U as O,j as e,S as w,I as X,d as k,a as j,g as L,b as P,c as V,s as U,u as z,e as B,f as J,h as q,i as H}from"./index-x0uMOy0q.js";import{u as Y}from"./useAuthRequired-BapI__VO.js";import{S as _}from"./Button-PWxjN8HO.js";function Z(){const{isAuthenticated:C}=Y("/register","/"),{loading:b,userAuth:p,userData:t,state:a,setState:d}=y.useContext(O),[x,S]=y.useState(0),[N,D]=y.useState(null);y.useEffect(()=>{const s=a.gastos.reduce((n,o)=>n+(parseFloat(o.gasto)||0),0);S(s)},[a.gastos]),y.useEffect(()=>(a.isModalOpen?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[a.isModalOpen]);const F=s=>{D(N===s?null:s)},M=async(s,n,o)=>{try{const m=k(j,"userPosts",p.username,"gastos",s,n,o),i=await L(m);if(i.exists()){const l=i.data();d(h=>({...h,gasto:l.gasto||"",title:l.title||"",remarks:l.remarks||"",category:l.category||"",type:l.type||"",date:l.createdAt?l.createdAt.toDate().toISOString().substring(0,10):"",fileURL:l.fileURL||"",isModalOpen:!0,currentGastoId:o}))}else console.error("No se encontró el gasto para editar.")}catch(m){console.error("Error al obtener los datos del gasto:",m)}},T=async(s,n,o)=>{if(console.log(s,n,o),window.confirm(`¿Estás seguro de que deseas eliminar el gasto con ID: ${o}?`))try{const i=k(j,"userPosts",p.username,"gastos",s,n,o);await P(i),console.log(`Gasto con ID: ${o} eliminado.`)}catch(i){console.error("Error al eliminar el gasto: ",i)}},A=()=>d(s=>({...s,isModalOpen:!0})),E=()=>d(s=>({...s,isModalOpen:!1})),G=s=>{const n=s.replace(/[^0-9]/g,"");return n.length===0?"":(parseFloat(n)/100).toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})},g=s=>{const{name:n,type:o,value:m,files:i}=s.target;if(o==="file")d(l=>({...l,[n]:i[0]}));else{const l=n==="gasto"?G(m):m;d(h=>({...h,[n]:l}))}},I=s=>{const{name:n}=s.target,o=a[n].replace(/[^0-9]/g,""),m=o.length===0?"":parseFloat(o)/100;d(i=>({...i,[n]:m.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}))},$=async s=>{s.preventDefault(),d(c=>({...c,isSubmitting:!0}));const n=parseFloat((a.gasto||"").toString().replace(/[^0-9.-]+/g,""));if(isNaN(n)||n<=0){d(c=>({...c,error:"Por favor, ingresa un gasto válido.",isSubmitting:!1}));return}const o=a.date?new Date(a.date+"T00:00:00"):new Date,m=o.getFullYear(),i=o.getMonth(),l=o.getDate(),h=(t==null?void 0:t.expenseControl.cutoffDay)||1,f=String(m);let r="";if(l<h)switch(i){case 0:r="diciembreEnero";break;case 1:r="eneroFebrero";break;case 2:r="febreroMarzo";break;case 3:r="marzoAbril";break;case 4:r="abrilMayo";break;case 5:r="mayoJunio";break;case 6:r="junioJulio";break;case 7:r="julioAgosto";break;case 8:r="agostoSeptiembre";break;case 9:r="septiembreOctubre";break;case 10:r="octubreNoviembre";break;case 11:r="noviembreDiciembre";break;default:r="desconocido"}else switch(i){case 0:r="eneroFebrero";break;case 1:r="febreroMarzo";break;case 2:r="marzoAbril";break;case 3:r="abrilMayo";break;case 4:r="mayoJunio";break;case 5:r="junioJulio";break;case 6:r="julioAgosto";break;case 7:r="agostoSeptiembre";break;case 8:r="septiembreOctubre";break;case 9:r="octubreNoviembre";break;case 10:r="noviembreDiciembre";break;case 11:r="diciembreEnero";break;default:r="desconocido"}try{let c=a.fileURL;if(a.file){const u=Date.now(),R=`${a.title}_${u}.${a.file.name.split(".").pop()}`,v=V(U,`userFiles/${p.username}/${R}`);await z(v,a.file),c=await B(v)}if(a.currentGastoId){const u=k(j,"userPosts",p.username,"gastos",f,r,String(a.currentGastoId));await J(u,{gasto:n,title:a.title,remarks:a.remarks,type:a.type,category:a.category,fileURL:c,user:p.username,createdAt:o,year:f,period:r})}else{const u=q(j,"userPosts",p.username,"gastos",f,r);await H(u,{gasto:n,title:a.title,remarks:a.remarks,type:a.type,category:a.category,fileURL:c,user:p.username,createdAt:o,year:f,period:r})}d(u=>({...u,gasto:"",title:"",remarks:"",category:"",type:"",file:null,isModalOpen:!1,error:"",currentGastoId:null}))}catch(c){console.error("Error al subir datos: ",c),d(u=>({...u,error:"Error al subir los datos: "+c.message,isSubmitting:!1}))}finally{d(c=>({...c,isSubmitting:!1}))}};return a.loading?e.jsx(w,{}):C?e.jsxs("div",{children:[e.jsxs("section",{className:"w-full max-w-screen-sm mt-6 py-3 flex flex-col items-center",children:[e.jsx("p",{className:"text-main-dark/50",children:"Gastos Totales"}),e.jsxs("h1",{className:"text-4xl font-bold text-main-dark my-2",children:["$",x.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("p",{className:`${!b&&t&&t.expenseControl&&t.expenseControl.budget-x<0?"text-main-primary":"text-main-highlight"}`,children:new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(!b&&t&&t.expenseControl&&t.expenseControl.budget-x.toFixed(2))})]}),e.jsx("section",{className:"w-full max-w-screen-sm flex justify-between items-center gap-2 py-3 px-6",children:e.jsxs("button",{onClick:A,className:"w-full flex-center gap-1 text-sm font-semibold bg-main-highlight/70 text-white rounded-3xl p-3 transition-colors duration-200 hover:bg-main-primary-dark",children:[e.jsx("i",{className:"flex-center w-6 h-6 rounded-full hover:scale-105",children:X.plus.fill("#FFFFFF")}),"Agregar Gasto"]})}),e.jsxs("section",{className:"w-full max-w-screen-sm py-3",children:[e.jsx("h2",{className:"text-main-dark text-lg font-semibold mb-4",children:"Resumen Mensual"}),e.jsxs("div",{className:"bg-main-dark/5 rounded-3xl p-4 flex justify-between items-center",children:[e.jsx("span",{className:"text-main-dark",children:"Presupuesto"}),e.jsxs("span",{className:"text-main-dark font-semibold",children:[" ",new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(!b&&t&&t.expenseControl&&t.expenseControl.budget)]})]}),e.jsxs("div",{className:"bg-main-dark/5 rounded-3xl p-4 flex justify-between items-center mt-2",children:[e.jsx("span",{className:"text-main-dark",children:"Gastos Totales"}),e.jsxs("span",{className:"text-main-dark font-semibold",children:["$",x.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:`${(!b&&t&&t.expenseControl&&t.expenseControl.budget-x)<0?"bg-main-dark/20":"bg-main-highlight/40"} rounded-3xl p-4 flex justify-between items-center mt-2`,children:[e.jsx("span",{className:"text-main-dark",children:"Saldo Actual"}),e.jsx("span",{className:`${x<0,"text-main-primary"} font-semibold`,children:new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(!b&&t&&t.expenseControl&&t.expenseControl.budget-x)})]})]}),e.jsxs("section",{className:"w-full max-w-screen-sm py-3 mb-20",children:[e.jsx("h2",{className:"text-main-dark text-lg font-semibold mb-4",children:"Últimos Gastos"}),e.jsx("ul",{className:"space-y-3",children:a.loading?e.jsx(w,{bgTheme:!0}):a.gastos.length>0?e.jsx("ul",{className:"space-y-3",children:a.gastos.sort((s,n)=>n.createdAt-s.createdAt).slice(0,6).map(s=>e.jsx(_,{context:t,data:s,onEdit:()=>M(s.year,s.period,s.id),onDelete:()=>T(s.year,s.period,s.id),expandedGastoId:N,onCardClick:F},s.id))}):e.jsx("li",{className:"flex justify-between items-center bg-main-dark/5 rounded-3xl p-4",children:e.jsx("span",{className:"text-main-dark font-medium",children:"No hay gastos registrados"})})})]}),a.isModalOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full h-[85vh] relative overflow-hidden",children:e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:E,className:"p-2 text-main-primary",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:a.isSubmitting,className:"p-2 text-main-highlight rounded hover:bg-main-primary-dark transition",children:a.isSubmitting?"Guardando...":a.currentGastoId?"Actualizar":"Agregar"})]}),e.jsxs("div",{className:"px-2",children:[e.jsxs("hgroup",{className:"rounded-3xl py-2 px-4 mb-4 bg-main-light",children:[e.jsx("input",{name:"title",type:"text",placeholder:"Concepto",value:a.title,onChange:g,className:"w-full py-2 bg-transparent outline-none border-b border-main-dark/20 text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsxs("div",{className:"flex-center pt-2 py-2",children:["$",e.jsx("input",{name:"gasto",type:"text",placeholder:"$ $",value:a.gasto,onChange:g,onBlur:I,className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),!b&&(t==null?void 0:t.expenseControl.currency)]})]}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"type",value:a.type,onChange:g,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),t.paymentTypes.card1&&e.jsx("option",{value:"card1",children:t.paymentTypes.card1}),t.paymentTypes.card2&&e.jsx("option",{value:"card2",children:t.paymentTypes.card2}),t.paymentTypes.card3&&e.jsx("option",{value:"card3",children:t.paymentTypes.card3}),t.paymentTypes.card4&&e.jsx("option",{value:"card4",children:t.paymentTypes.card4}),t.paymentTypes.card5&&e.jsx("option",{value:"card5",children:t.paymentTypes.card5}),t.paymentTypes.other&&e.jsx("option",{value:"other",children:t.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"category",value:a.category,onChange:g,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Categorías"}),e.jsx("option",{value:"feeding",children:"Alimentación y Bebidas"}),e.jsx("option",{value:"transportation",children:"Transporte"}),e.jsx("option",{value:"health",children:"Salud y Bienestar"}),e.jsx("option",{value:"educationJob",children:"Gastos de Educación o Trabajo"}),e.jsx("option",{value:"housing",children:"Vivienda"}),e.jsx("option",{value:"entertainment",children:"Entretenimiento y Ocio"}),e.jsx("option",{value:"personalCare",children:"Ropa y Cuidado Personal"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{id:"date",name:"date",type:"date",value:a.date,onChange:g,className:"w-full bg-transparent outline-none text-main-dark placeholder:text-main-dark/50"})}),!a.currentGastoId&&e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{name:"file",type:"file",onChange:g,className:"w-full",accept:"image/*, .pdf"})}),e.jsx("textarea",{name:"remarks",placeholder:"Observaciones",value:a.remarks,onChange:g,rows:"4",className:"w-full rounded-3xl p-4 mb-4 outline-none bg-main-light"})]})]})})})]}):null}export{Z as default};
