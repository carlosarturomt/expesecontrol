import{r as g,U as oe,j as e,I as u,d as E,c as N,k as le,a as R,s as B,l as ie,m as ce,b as de,g as me,e as ue,f as pe,h as ge}from"./index-WWc8y-UN.js";import{f as V,g as U,C as be,A as ye,p as he,a as xe,b as fe,L as Ce,c as je,d as ke,e as we,B as ve}from"./index-DkO38PuL.js";import{F as Ne,S as Se}from"./Button-DJoFkQP8.js";be.register(ye,he,xe,fe,Ce,je,ke,we,ve);function De(){const{loading:S,userAuth:x,userData:r,state:o,setState:b}=g.useContext(oe),[j,I]=g.useState([]),[D,_]=g.useState({}),[w,A]=g.useState(null),[F,v]=g.useState("current"),[L,J]=g.useState(null),[y,P]=g.useState(""),[z,q]=g.useState(0),[T,Y]=g.useState(!0),[M,X]=g.useState(!0),[O,G]=g.useState(!0),W={card1:r&&r.paymentTypes&&r.paymentTypes.card1,card2:r&&r.paymentTypes&&r.paymentTypes.card2,card3:r&&r.paymentTypes&&r.paymentTypes.card3,card4:r&&r.paymentTypes&&r.paymentTypes.card4,card5:r&&r.paymentTypes&&r.paymentTypes.card5,other:r&&r.paymentTypes&&r.paymentTypes.other,cash:"Efectivo"};g.useEffect(()=>{var n;if(!r||!o.ingresos||S)return;const t=parseInt((n=r==null?void 0:r.expenseControl)==null?void 0:n.cutoffDay,10)||12,l=new Date,c=l.getDate(),s=l.getMonth(),d=l.getFullYear();let m,p;switch(F){case"previous":m=new Date(d,s-1,t),p=new Date(d,s,t-1,23,59,59);break;case"year":m=new Date(d,0,1),p=new Date(d,11,31);break;case"all":I(o.ingresos.filter(a=>a.title.toLowerCase().includes(y.toLowerCase())||a.remarks.toLowerCase().includes(y.toLowerCase())||a.category.toLowerCase().includes(y.toLowerCase())).sort((a,i)=>i.createdAt-a.createdAt));return;default:m=new Date(d,s-(c<t?1:0),t),p=new Date(m.getFullYear(),m.getMonth()+1,t-1,23,59,59)}const k=o.ingresos.filter(a=>{const i=a.createdAt instanceof Date?a.createdAt:a.createdAt.toDate();return i>=m&&i<=p});q(k.reduce((a,i)=>a+(parseFloat(i.ingreso)||0),0)),I(k.filter(a=>a.title.toLowerCase().includes(y.toLowerCase())||a.remarks.toLowerCase().includes(y.toLowerCase())||a.category.toLowerCase().includes(y.toLowerCase())).sort((a,i)=>i.createdAt-a.createdAt))},[o.ingresos,r,F,S,y]),g.useEffect(()=>{if(j.length===0){A(null);return}const t=j.reduce((a,i)=>(a[i.category]||(a[i.category]=0),a[i.category]+=parseFloat(i.ingreso)||0,a),{}),l={feeding:"Alimentación y Bebidas",transportation:"Transporte",health:"Salud y Bienestar",educationJob:"Educación o Trabajo",housing:"Vivienda",entertainment:"Entretenimiento y Ocio",personalCare:"Ropa y Cuidado Personal"},s={labels:Object.keys(t).map(a=>l[a]||a),datasets:[{label:"Ingresos por Categoría",data:Object.values(t),backgroundColor:["rgba(255, 99, 132, 0.2)","rgba(255, 159, 64, 0.2)","rgba(255, 205, 86, 0.2)","rgba(75, 192, 192, 0.2)","rgba(54, 162, 235, 0.2)","rgba(153, 102, 255, 0.2)","rgba(201, 203, 207, 0.2)"],borderColor:["rgb(255, 99, 132)","rgb(255, 159, 64)","rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(54, 162, 235)","rgb(153, 102, 255)","rgb(201, 203, 207)"],borderWidth:1}]},d=j.reduce((a,i)=>(a[i.type]||(a[i.type]=0),a[i.type]+=parseFloat(i.ingreso)||0,a),{}),m=Object.keys(d),p=Object.values(d),n={labels:m.map(a=>W[a]||a),datasets:[{label:"Ingresos por Tipo de Pago",data:p,backgroundColor:["rgba(201, 203, 207, 0.2)","rgba(153, 102, 255, 0.2)","rgba(54, 162, 235, 0.2)","rgba(75, 192, 192, 0.2)","rgba(255, 205, 86, 0.2)","rgba(255, 159, 64, 0.2)","rgba(255, 99, 132, 0.2)"],borderColor:["rgb(201, 203, 207)","rgb(153, 102, 255)","rgb(54, 162, 235)","rgb(75, 192, 192)","rgb(255, 205, 86)","rgb(255, 159, 64)","rgb(255, 99, 132)"],borderWidth:1}]};_(n),A(s)},[j,y]);const H=async t=>{try{const l=E(N,"userPosts",x.username,"ingresos",t),c=await le(l);if(c.exists()){const s=c.data();b(d=>({...d,ingreso:(s==null?void 0:s.ingreso)||"",title:(s==null?void 0:s.title)||"",remarks:(s==null?void 0:s.remarks)||"",category:(s==null?void 0:s.category)||"",type:(s==null?void 0:s.type)||"",date:s!=null&&s.createdAt?s.createdAt.toDate().toISOString().substring(0,10):"",fileURL:(s==null?void 0:s.fileURL)||"",isModalOpen:!0,currentIncomeId:t}))}else console.error(`El income con ID: ${t} no existe.`)}catch(l){console.error("Error al obtener los datos del income:",l)}},K=async(t,l,c)=>{if(window.confirm(`¿Estás seguro de que deseas eliminar el income "${l.title}" de $${l.ingreso}?`))try{const d=E(N,"userPosts",x.username,"ingresos",t);if(c&&c.trim()!==""){const m=R(B,`userFiles/${x.username}/${c}`);try{await ie(m),console.log("Imagen asociada eliminada de Storage.")}catch(p){console.error("Error al eliminar la imagen de Storage: ",p)}}else console.log("No se proporcionó una imagen para eliminar.");await ce(d),console.log("Ingreso eliminado correctamente."),b(m=>({...m,ingresos:m.ingresos.filter(p=>p.id!==t)}))}catch(d){console.error("Error al eliminar el ingreso: ",d),alert("No se pudo eliminar el ingreso. Intenta nuevamente.")}},Q=t=>{J(L===t?null:t)},h=t=>{t!==void 0&&P(t)},Z=[{slug:()=>v("all"),label:"Todos los ingresos",icon:u.all.border("#1C1C1E")},{slug:()=>v("current"),label:"Periodo actual",icon:u.today.border("#1C1C1E")},{slug:()=>v("previous"),label:"Periodo anterior",icon:u.previous.border("#1C1C1E")},{slug:()=>v("year"),label:"Año actual",icon:u.calendar.border("#1C1C1E")}],ee=[{slug:()=>h(""),label:"Todas las categorías",anchor:"",icon:u.all.border("#1C1C1E")},{slug:()=>h("feeding"),label:"Alimentación y bebidas",anchor:"feeding",icon:u.restaurant.fill("#1C1C1E")},{slug:()=>h("transportation"),label:"Transporte",anchor:"transportation",icon:u.transportation.border("#1C1C1E")},{slug:()=>h("health"),label:"Salud y bienestar",anchor:"health",icon:u.care.border("#1C1C1E")},{slug:()=>h("educationJob"),label:"Educación o trabajo",anchor:"educationJob",icon:u.ruler.border("#1C1C1E")},{slug:()=>h("housing"),label:"Vivienda",anchor:"housing",icon:u.house.border("#1C1C1E")},{slug:()=>h("entertainment"),label:"Entretenimiento y ocio",anchor:"entertainment",icon:u.theater_masks.border("#1C1C1E")},{slug:()=>h("personalCare"),label:"Ropa y cuidado personal",anchor:"personalCare",icon:u.beauty.border("#1C1C1E")}],te=()=>b(t=>({...t,isModalOpen:!1})),ae=t=>{const l=t.replace(/[^0-9]/g,"");return l.length===0?"":(parseFloat(l)/100).toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})},f=t=>{const{name:l,type:c,value:s,files:d}=t.target;if(c==="file")b(m=>({...m,[l]:d[0]}));else{const m=l==="ingreso"?ae(s):s;b(p=>({...p,[l]:m}))}},re=t=>{const{name:l}=t.target,c=o[l].replace(/[^0-9]/g,""),s=c.length===0?"":parseFloat(c)/100;b(d=>({...d,[l]:s.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}))},se=async t=>{t.preventDefault(),b(a=>({...a,isSubmitting:!0}));const l=parseFloat((o.ingreso||"").toString().replace(/[^0-9.-]+/g,""));if(isNaN(l)||l<=0){b(a=>({...a,error:"Por favor, ingresa un ingresp válido.",isSubmitting:!1})),console.log("Por favor, ingresa un ingresp válido.");return}const c=o.date?new Date(o.date+"T00:00:00"):new Date,s=c.getFullYear(),d=c.getMonth(),m=c.getDate(),p=(r==null?void 0:r.expenseControl.cutoffDay)||1,k=String(s);let n="";if(m<p)switch(d){case 0:n="diciembreEnero";break;case 1:n="eneroFebrero";break;case 2:n="febreroMarzo";break;case 3:n="marzoAbril";break;case 4:n="abrilMayo";break;case 5:n="mayoJunio";break;case 6:n="junioJulio";break;case 7:n="julioAgosto";break;case 8:n="agostoSeptiembre";break;case 9:n="septiembreOctubre";break;case 10:n="octubreNoviembre";break;case 11:n="noviembreDiciembre";break;default:n="desconocido"}else switch(d){case 0:n="eneroFebrero";break;case 1:n="febreroMarzo";break;case 2:n="marzoAbril";break;case 3:n="abrilMayo";break;case 4:n="mayoJunio";break;case 5:n="junioJulio";break;case 6:n="julioAgosto";break;case 7:n="agostoSeptiembre";break;case 8:n="septiembreOctubre";break;case 9:n="octubreNoviembre";break;case 10:n="noviembreDiciembre";break;case 11:n="diciembreEnero";break;default:n="desconocido"}try{let a=o.fileURL;if(o.file){const C=Date.now(),ne=`${o.title}_${C}.${o.file.name.split(".").pop()}`,$=R(B,`userFiles/${x.username}/${ne}`);await de($,o.file),a=await me($)}const i={ingreso:l,title:o.title,remarks:o.remarks,type:o.type,category:o.category,user:x.username,createdAt:c,year:k,period:n};if(a&&(i.fileURL=a),o.currentIncomeId){const C=E(N,"userPosts",x.username,"ingresos",String(o.currentIncomeId));await ue(C,i)}else{const C=pe(N,"userPosts",x.username,"ingresos");await ge(C,i)}b(C=>({...C,ingreso:"",title:"",remarks:"",category:"",type:"",file:null,isModalOpen:!1,error:"",currentIncomeId:null})),setTimeout(()=>location.reload(),1e3)}catch(a){console.error("Error al subir datos: ",a),b(i=>({...i,error:"Error al subir los datos: "+a.message,isSubmitting:!1}))}finally{b(a=>({...a,isSubmitting:!1}))}};return e.jsxs("section",{className:"mx-auto p-4 mb-20",children:[e.jsxs("aside",{className:"py-2 mb-2 flex justify-center flex-col gap-2",children:[e.jsxs("div",{className:"w-full flex-center pl-4 rounded-3xl bg-main-dark/5",children:[e.jsx("i",{className:"flex-center w-6 h-6 opacity-40",children:u.search.border("#1C1C1E")}),e.jsx("input",{type:"text",placeholder:"Filtrar ingresos...",value:y,onChange:t=>P(t.target.value),className:"w-full h-full pl-1 py-4 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsx(Ne,{label:e.jsx("i",{className:"flex-center w-6 h-6",children:u.filter.fill("#00A86B")}),titleSectionOne:"Filtrar por periodo",itemsSectionOne:Z,titleSectionTwo:"Filtrar por categoría",itemsSectionTwo:ee})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Y(t=>!t),className:"flex-center w-10 h-10 p-2 rounded-full bg-main-highlight/70 text-main-light",children:T?u.chart.border("#F5F6FA"):u.chart_line.border("#F5F6FA")}),e.jsx("button",{onClick:()=>X(t=>!t),className:`w-fit flex-center gap-1 h-10 px-4 rounded-3xl ${M?"bg-main-highlight/70 text-main-light":"bg-main-dark/5 text-main-dark/50"}`,children:"Categoría"}),e.jsx("button",{onClick:()=>G(t=>!t),className:`w-fit flex-center gap-1 h-10 px-4 rounded-3xl ${O?"bg-main-highlight/70 text-main-light":"bg-main-dark/5 text-main-dark/50"}`,children:"Método de pago"})]})]}),e.jsxs("hgroup",{className:"mb-2",children:[e.jsx("h1",{className:"text-main-dark py-2 text-lg font-semibold border-b border-main-dark/20",children:"Detalles de Ingresos"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"py-2 text-sm font-light text-main-dark/50",children:[j.length," Resultados"]}),e.jsxs("p",{className:"py-2 text-sm font-light text-main-dark/50",children:["$",z.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})," Ingresos"]})]})]}),e.jsx("div",{className:"flex gap-4 mb-3",children:w?e.jsxs("div",{className:"w-full flex-center flex-col space-y-3",children:[M&&e.jsxs("div",{className:"w-full p-4 flex justify-center flex-col rounded-3xl bg-main-dark/5",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Intresos por categoría"}),T?e.jsx(V,{data:w,options:{indexAxis:"y",plugins:{legend:{display:!1}}}}):e.jsx(U,{data:w,options:{indexAxis:"y",plugins:{legend:{display:!1}}}})]}),O&&e.jsxs("div",{className:"w-full p-4 flex justify-center flex-col rounded-3xl bg-main-dark/5",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Intresos por tipo de pago"}),T?e.jsx(V,{data:D,options:{plugins:{legend:{display:!1}}}}):e.jsx(U,{data:D,options:{plugins:{legend:{display:!1}}}})]})]}):w==null?e.jsx("p",{className:"text-center text-gray-500",children:"Sin resultados"}):e.jsx("p",{className:"text-center text-gray-500",children:"Cargando gráficos..."})}),e.jsx("ul",{className:"space-y-3",children:j.sort((t,l)=>{const c=t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt);return(l.createdAt instanceof Date?l.createdAt:new Date(l.createdAt))-c}).map(t=>e.jsx(Se,{context:r,data:t,onEdit:()=>H(t.id),onDelete:()=>K(t.id,t,t.image&&t.image.name),expandedGastoId:L,onCardClick:Q},t.id))}),o.isModalOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full h-[85vh] relative overflow-hidden",children:e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:te,className:"p-2 text-main-primary",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:o.isSubmitting,className:"p-2 text-main-highlight rounded hover:bg-main-primary-dark transition",children:o.isSubmitting?"Guardando...":o.currentIncomeId?"Actualizar":"Agregar"})]}),e.jsxs("div",{className:"px-2",children:[e.jsxs("hgroup",{className:"rounded-3xl py-2 px-4 mb-4 bg-main-light",children:[e.jsx("input",{name:"title",type:"text",placeholder:"Concepto",value:o.title,onChange:f,className:"w-full py-2 bg-transparent outline-none border-b border-main-dark/20 text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsxs("div",{className:"flex-center pt-2 py-2",children:["$",e.jsx("input",{name:"ingreso",type:"text",placeholder:"$ $",value:o.ingreso,onChange:f,onBlur:re,className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),!S&&(r==null?void 0:r.expenseControl.currency)]})]}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"type",value:o.type,onChange:f,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),r.incomeControl.paymentTypes.type1&&e.jsx("option",{value:"type1",children:r.incomeControl.paymentTypes.type1}),r.incomeControl.paymentTypes.type2&&e.jsx("option",{value:"type2",children:r.incomeControl.paymentTypes.type2}),r.incomeControl.paymentTypes.type3&&e.jsx("option",{value:"type3",children:r.incomeControl.paymentTypes.type3}),r.incomeControl.paymentTypes.type4&&e.jsx("option",{value:"type4",children:r.incomeControl.paymentTypes.type4}),r.incomeControl.paymentTypes.type5&&e.jsx("option",{value:"type5",children:r.incomeControl.paymentTypes.type5}),r.incomeControl.paymentTypes.other&&e.jsx("option",{value:"other",children:r.incomeControl.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"category",value:o.category,onChange:f,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"salary",children:"Salario"}),e.jsx("option",{value:"business",children:"Negocios"}),e.jsx("option",{value:"investment",children:"Inversiones"}),e.jsx("option",{value:"other",children:"Otros Ingresos"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{id:"date",name:"date",type:"date",value:o.date,onChange:f,className:"w-full bg-transparent outline-none text-main-dark placeholder:text-main-dark/50"})}),!o.currentIncomeId&&e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{name:"file",type:"file",onChange:f,className:"w-full",accept:"image/*, .pdf"})}),e.jsx("textarea",{name:"remarks",placeholder:"Observaciones",value:o.remarks,onChange:f,rows:"4",className:"w-full rounded-3xl p-4 mb-4 outline-none bg-main-light"})]})]})})})]})}export{De as default};
