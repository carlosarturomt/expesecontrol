import{r as b,U as P,j as e,S as N,I as V,d as j,a as y,g as U,b as z,c as q,s as B,u as J,e as X,f as Y,h as _,i as H}from"./index-CnVaEKSz.js";import{u as K}from"./useAuthRequired-h4MVx1Ch.js";import{S as Q}from"./Button-DEwKkQcm.js";function te(){const{isLoading:C,isAuthenticated:S}=K("/register","/transactions"),{loading:D,userAuth:p,userData:o,state:t,setState:u}=b.useContext(P),[W,T]=b.useState(0),[v,A]=b.useState(null);b.useEffect(()=>{const a=t.gastos.reduce((r,n)=>r+(parseFloat(n.gasto)||0),0);T(a)},[t.gastos]),b.useEffect(()=>(t.isModalOpen?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[t.isModalOpen]);const[f,E]=b.useState(""),k=t.gastos.filter(a=>a.title.toLowerCase().includes(f.toLowerCase())||a.remarks.toLowerCase().includes(f.toLowerCase())).sort((a,r)=>r.createdAt-a.createdAt),G=a=>{A(v===a?null:a)},F=async(a,r,n)=>{try{const d=j(y,"userPosts",p.username,"gastos",a,r,n),i=await U(d);if(i.exists()){const l=i.data();u(h=>({...h,gasto:l.gasto||"",title:l.title||"",remarks:l.remarks||"",category:l.category||"",type:l.type||"",date:l.createdAt?l.createdAt.toDate().toISOString().substring(0,10):"",fileURL:l.fileURL||"",isModalOpen:!0,currentGastoId:n}))}else console.error("No se encontró el gasto para editar.")}catch(d){console.error("Error al obtener los datos del gasto:",d)}},M=async(a,r,n)=>{if(console.log(a,r,n),window.confirm(`¿Estás seguro de que deseas eliminar el gasto con ID: ${n}?`))try{const i=j(y,"userPosts",p.username,"gastos",a,r,n);await z(i),console.log(`Gasto con ID: ${n} eliminado.`)}catch(i){console.error("Error al eliminar el gasto: ",i)}},I=()=>u(a=>({...a,isModalOpen:!1})),R=a=>{const r=a.replace(/[^0-9]/g,"");return r.length===0?"":(parseFloat(r)/100).toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})},g=a=>{const{name:r,type:n,value:d,files:i}=a.target;if(n==="file")u(l=>({...l,[r]:i[0]}));else{const l=r==="gasto"?R(d):d;u(h=>({...h,[r]:l}))}},L=a=>{const{name:r}=a.target,n=t[r].replace(/[^0-9]/g,""),d=n.length===0?"":parseFloat(n)/100;u(i=>({...i,[r]:d.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}))},O=async a=>{a.preventDefault(),u(c=>({...c,isSubmitting:!0}));const r=parseFloat((t.gasto||"").toString().replace(/[^0-9.-]+/g,""));if(isNaN(r)||r<=0){u(c=>({...c,error:"Por favor, ingresa un gasto válido.",isSubmitting:!1}));return}const n=t.date?new Date(t.date+"T00:00:00"):new Date,d=n.getFullYear(),i=n.getMonth(),l=n.getDate(),h=p.cutoffDay||12,x=String(d);let s="";if(l<h)switch(i){case 0:s="diciembreEnero";break;case 1:s="eneroFebrero";break;case 2:s="febreroMarzo";break;case 3:s="marzoAbril";break;case 4:s="abrilMayo";break;case 5:s="mayoJunio";break;case 6:s="junioJulio";break;case 7:s="julioAgosto";break;case 8:s="agostoSeptiembre";break;case 9:s="septiembreOctubre";break;case 10:s="octubreNoviembre";break;case 11:s="noviembreDiciembre";break;default:s="desconocido"}else switch(i){case 0:s="eneroFebrero";break;case 1:s="febreroMarzo";break;case 2:s="marzoAbril";break;case 3:s="abrilMayo";break;case 4:s="mayoJunio";break;case 5:s="junioJulio";break;case 6:s="julioAgosto";break;case 7:s="agostoSeptiembre";break;case 8:s="septiembreOctubre";break;case 9:s="octubreNoviembre";break;case 10:s="noviembreDiciembre";break;case 11:s="diciembreEnero";break;default:s="desconocido"}try{let c=t.fileURL;if(t.file){const m=Date.now(),$=`${t.title}_${m}.${t.file.name.split(".").pop()}`,w=q(B,`userFiles/${p.username}/${$}`);await J(w,t.file),c=await X(w)}if(t.currentGastoId){const m=j(y,"userPosts",p.username,"gastos",x,s,String(t.currentGastoId));await Y(m,{gasto:r,title:t.title,remarks:t.remarks,type:t.type,category:t.category,fileURL:c,user:p.username,createdAt:n,year:x,period:s})}else{const m=_(y,"userPosts",p.username,"gastos",x,s);await H(m,{gasto:r,title:t.title,remarks:t.remarks,type:t.type,category:t.category,fileURL:c,user:p.username,createdAt:n,year:x,period:s})}u(m=>({...m,gasto:"",title:"",remarks:"",category:"",type:"",file:null,isModalOpen:!1,error:"",currentGastoId:null}))}catch(c){console.error("Error al subir datos: ",c),u(m=>({...m,error:"Error al subir los datos: "+c.message,isSubmitting:!1}))}finally{u(c=>({...c,isSubmitting:!1}))}};return C?e.jsx(N,{bgTheme:!0}):S?e.jsxs("div",{children:[e.jsx("section",{className:"w-full max-w-screen-sm mt-6 py-3 flex flex-col items-center",children:e.jsx("p",{className:"text-main-dark/50",children:"Transacciones"})}),e.jsx("section",{className:"relative rounded-3xl py-2 px-4 mb-4 bg-main-dark/5",children:e.jsxs("div",{className:"flex-center pt-2 py-2",children:[e.jsx("i",{className:"flex-center w-6 h-6 opacity-30",children:V.search.fill("#1C1C1E")}),e.jsx("input",{type:"text",placeholder:"Filtrar gastos...",value:f,onChange:a=>E(a.target.value),className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0})]})}),e.jsxs("section",{className:"w-full max-w-screen-sm py-3 mb-20",children:[e.jsx("h2",{className:"text-main-dark text-lg font-semibold mb-4",children:"Gastos"}),t.loading?e.jsx(N,{bgTheme:!0}):k.length>0?e.jsx("ul",{className:"space-y-3",children:k.sort((a,r)=>r.createdAt-a.createdAt).map(a=>e.jsx(Q,{context:o,data:a,onEdit:()=>F(a.year,a.period,a.id),onDelete:()=>M(a.year,a.period,a.id),expandedGastoId:v,onCardClick:G},a.id))}):e.jsx("li",{className:"flex justify-between items-center bg-main-dark/5 rounded-3xl p-4",children:e.jsx("span",{className:"text-main-dark font-medium",children:"No hay gastos registrados"})})]}),t.isModalOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full h-[85vh] relative overflow-hidden",children:e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:I,className:"p-2 text-main-primary",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:t.isSubmitting,className:"p-2 text-main-highlight rounded hover:bg-main-primary-dark transition",children:t.isSubmitting?"Guardando...":t.currentGastoId?"Actualizar":"Agregar"})]}),e.jsxs("div",{className:"px-2",children:[e.jsxs("hgroup",{className:"rounded-3xl py-2 px-4 mb-4 bg-main-light",children:[e.jsx("input",{name:"title",type:"text",placeholder:"Concepto",value:t.title,onChange:g,className:"w-full py-2 bg-transparent outline-none border-b border-main-dark/20 text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsxs("div",{className:"flex-center pt-2 py-2",children:["$",e.jsx("input",{name:"gasto",type:"text",placeholder:"$ $",value:t.gasto,onChange:g,onBlur:L,className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),!D&&(o==null?void 0:o.expenseControl.currency)]})]}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"type",value:t.type,onChange:g,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),o.paymentTypes.card1&&e.jsx("option",{value:"card1",children:o.paymentTypes.card1}),o.paymentTypes.card2&&e.jsx("option",{value:"card2",children:o.paymentTypes.card2}),o.paymentTypes.card3&&e.jsx("option",{value:"card3",children:o.paymentTypes.card3}),o.paymentTypes.card4&&e.jsx("option",{value:"card4",children:o.paymentTypes.card4}),o.paymentTypes.card5&&e.jsx("option",{value:"card5",children:o.paymentTypes.card5}),o.paymentTypes.other&&e.jsx("option",{value:"other",children:o.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"category",value:t.category,onChange:g,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Categorías"}),e.jsx("option",{value:"feeding",children:"Alimentación y Bebidas"}),e.jsx("option",{value:"transportation",children:"Transporte"}),e.jsx("option",{value:"health",children:"Salud y Bienestar"}),e.jsx("option",{value:"educationJob",children:"Gastos de Educación o Trabajo"}),e.jsx("option",{value:"housing",children:"Vivienda"}),e.jsx("option",{value:"entertainment",children:"Entretenimiento y Ocio"}),e.jsx("option",{value:"personalCare",children:"Ropa y Cuidado Personal"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{id:"date",name:"date",type:"date",value:t.date,onChange:g,className:"w-full bg-transparent outline-none text-main-dark placeholder:text-main-dark/50"})}),!t.currentGastoId&&e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{name:"file",type:"file",onChange:g,className:"w-full",accept:"image/*, .pdf"})}),e.jsx("textarea",{name:"remarks",placeholder:"Observaciones",value:t.remarks,onChange:g,rows:"4",className:"w-full rounded-3xl p-4 mb-4 outline-none bg-main-light"})]})]})})})]}):null}export{te as default};
