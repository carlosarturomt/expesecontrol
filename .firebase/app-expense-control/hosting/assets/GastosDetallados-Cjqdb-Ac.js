import{r as u,U,j as s,I as F,d as L,b as T,h as _,a as V,s as Y,i as q,k as J}from"./index-oWpmuPqm.js";import{P as W,f as X,C as z,A as H,p as K,a as Q,b as Z,L as ee,c as te,d as ae,e as se,B as re}from"./index-B3WPttk8.js";import{F as oe,S as ne}from"./Button-DMsbFMBo.js";z.register(H,K,Q,Z,ee,te,ae,se,re);function de(){const{loading:C,userAuth:f,userData:r,state:h,setState:j}=u.useContext(U),[y,w]=u.useState([]),[S,k]=u.useState({}),[A,v]=u.useState(null),[x,N]=u.useState("current"),[E,B]=u.useState(null),[p,D]=u.useState(""),[G,P]=u.useState(0),I={card1:r&&r.paymentTypes&&r.paymentTypes.card1,card2:r&&r.paymentTypes&&r.paymentTypes.card2,card3:r&&r.paymentTypes&&r.paymentTypes.card3,card4:r&&r.paymentTypes&&r.paymentTypes.card4,card5:r&&r.paymentTypes&&r.paymentTypes.card5,other:r&&r.paymentTypes&&r.paymentTypes.other,cash:"Efectivo"};u.useEffect(()=>{var g;if(!r||!h.gastos||C)return;const e=parseInt((g=r==null?void 0:r.expenseControl)==null?void 0:g.cutoffDay,10)||12,o=new Date,i=o.getDate(),a=o.getMonth(),l=o.getFullYear();let c,d;switch(x){case"previous":c=new Date(l,a-1,e),d=new Date(l,a,e-1,23,59,59);break;case"year":c=new Date(l,0,1),d=new Date(l,11,31);break;case"all":w(h.gastos.filter(t=>t.title.toLowerCase().includes(p.toLowerCase())||t.remarks.toLowerCase().includes(p.toLowerCase())||t.category.toLowerCase().includes(p.toLowerCase())).sort((t,n)=>n.createdAt-t.createdAt));return;default:c=new Date(l,a-(i<e?1:0),e),d=new Date(c.getFullYear(),c.getMonth()+1,e-1,23,59,59)}const b=h.gastos.filter(t=>{const n=t.createdAt instanceof Date?t.createdAt:t.createdAt.toDate();return n>=c&&n<=d});P(b.reduce((t,n)=>t+(parseFloat(n.gasto)||0),0)),w(b.filter(t=>t.title.toLowerCase().includes(p.toLowerCase())||t.remarks.toLowerCase().includes(p.toLowerCase())||t.category.toLowerCase().includes(p.toLowerCase())).sort((t,n)=>n.createdAt-t.createdAt))},[h.gastos,r,x,C,p]),u.useEffect(()=>{if(y.length===0){v(null);return}const e=y.reduce((t,n)=>(t[n.category]||(t[n.category]=0),t[n.category]+=parseFloat(n.gasto)||0,t),{}),o={feeding:"Alimentación y Bebidas",transportation:"Transporte",health:"Salud y Bienestar",educationJob:"Gastos de Educación o Trabajo",housing:"Vivienda",entertainment:"Entretenimiento y Ocio",personalCare:"Ropa y Cuidado Personal"},a={labels:Object.keys(e).map(t=>o[t]||t),datasets:[{label:"Gastos por Categoría",data:Object.values(e),backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF"]}]},l=y.reduce((t,n)=>(t[n.type]||(t[n.type]=0),t[n.type]+=parseFloat(n.gasto)||0,t),{}),c=Object.keys(l),d=Object.values(l),g={labels:c.map(t=>I[t]||t),datasets:[{label:"Gastos por Tipo de Pago",data:d,backgroundColor:["#495867","#36A2EB","#FFCE56","#4BC0C0","#9966FF"],borderColor:"#fff",borderWidth:1}]};k(g),v(a)},[y,p]);const O=async e=>{try{const o=L(T,"userPosts",f.username,"gastos",e),i=await _(o);if(i.exists()){const a=i.data();j(l=>({...l,gasto:(a==null?void 0:a.gasto)||"",title:(a==null?void 0:a.title)||"",remarks:(a==null?void 0:a.remarks)||"",category:(a==null?void 0:a.category)||"",type:(a==null?void 0:a.type)||"",date:a!=null&&a.createdAt?a.createdAt.toDate().toISOString().substring(0,10):"",fileURL:(a==null?void 0:a.fileURL)||"",isModalOpen:!0,currentGastoId:e}))}else console.error(`El gasto con ID: ${e} no existe.`)}catch(o){console.error("Error al obtener los datos del gasto:",o)}},R=async(e,o,i)=>{if(window.confirm(`¿Estás seguro de que deseas eliminar el gasto "${o.title}" de $${o.gasto}?`))try{const l=L(T,"userPosts",f.username,"gastos",e);if(i&&i.trim()!==""){const c=V(Y,`userFiles/${f.username}/${i}`);try{await q(c),console.log("Imagen asociada eliminada de Storage.")}catch(d){console.error("Error al eliminar la imagen de Storage: ",d)}}else console.log("No se proporcionó una imagen para eliminar.");await J(l),console.log("Gasto eliminado correctamente."),j(c=>({...c,gastos:c.gastos.filter(d=>d.id!==e)}))}catch(l){console.error("Error al eliminar el gasto: ",l),alert("No se pudo eliminar el gasto. Intenta nuevamente.")}},M=e=>{B(E===e?null:e)},m=e=>{const o=e.target.value;o!==void 0&&D(o)},$=[{slug:m,label:"Todos",anchor:""},{slug:m,label:"Alimentación y Bebidas",anchor:"feeding"},{slug:m,label:"Transporte",anchor:"transportation"},{slug:m,label:"Salud y Bienestar",anchor:"health"},{slug:m,label:"Gastos de Educación o Trabajo",anchor:"educationJob"},{slug:m,label:"Vivienda",anchor:"housing"},{slug:m,label:"Entretenimiento y Ocio",anchor:"entertainment"},{slug:m,label:"Ropa y Cuidado Personal",anchor:"personalCare"}];return s.jsxs("section",{className:"container mx-auto p-4 mb-20",children:[s.jsx("div",{className:"relative py-2 mb-2 flex items-center",children:s.jsxs("div",{className:"w-full flex-center pl-4 rounded-3xl bg-main-dark/5",children:[s.jsx("i",{className:"flex-center w-6 h-6 opacity-40",children:F.search.border("#1C1C1E")}),s.jsx("input",{type:"text",placeholder:"Filtrar gastos...",value:p,onChange:e=>D(e.target.value),className:"w-full h-full pl-1 py-4 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),s.jsx(oe,{label:s.jsx("i",{className:"flex-center w-6 h-6",children:F.filter.fill("#C2185B")}),items:$})]})}),s.jsxs("div",{className:"flex  items-center gap-3 mb-4",children:[s.jsxs("select",{value:x,onChange:e=>N(e.target.value),className:"border p-2 rounded",children:[s.jsx("option",{value:"current",children:"Periodo Actual"}),s.jsx("option",{value:"previous",children:"Periodo Anterior"}),s.jsx("option",{value:"year",children:"Año Actual"}),s.jsx("option",{value:"all",children:"Todos los Gastos"})]}),s.jsxs("p",{className:"text-xl font-medium text-main-dark",children:["$",G.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]})]}),s.jsxs("hgroup",{className:"mb-2",children:[s.jsx("h1",{className:"text-main-dark py-2 text-lg font-semibold border-b border-main-dark/20",children:"Detalles de Gastos"}),s.jsxs("p",{className:"py-2 text-sm font-light text-main-dark/50",children:[y.length," Resultados"]})]}),s.jsx("div",{className:"flex gap-4 mb-4",children:A?s.jsxs("div",{className:"w-full flex-center flex-col space-y-6",children:[s.jsx("div",{className:"w-full flex-center",children:s.jsx(W,{data:A})}),s.jsx("div",{className:"w-full flex-center",children:s.jsx(X,{data:S})})]}):s.jsx("p",{className:"text-center text-gray-500",children:"Cargando gráficos..."})}),s.jsx("h2",{className:"text-lg font-bold mb-2",children:"Listado de Gastos"}),s.jsx("ul",{className:"space-y-3",children:y.sort((e,o)=>{const i=e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt);return(o.createdAt instanceof Date?o.createdAt:new Date(o.createdAt))-i}).map(e=>s.jsx(ne,{context:r,data:e,onEdit:()=>O(e.id),onDelete:()=>R(e.id,e,e.image&&e.image.name),expandedGastoId:E,onCardClick:M},e.id))})]})}export{de as default};
