import{r as c,U as le,j as e,S as oe,I as x,N as ie,a as ce,s as de,u as me,g as ue,d as pe,b as V,c as xe,e as ge,f as he}from"./index-pNOXhOLA.js";import{u as fe}from"./useAuthRequired-CMkwRkcB.js";import{P as R,C as ye,A as be,p as je,a as we,b as Ne,L as ve,c as De,d as Ce,e as Fe,B as Se}from"./index-2aCvmTlO.js";ye.register(be,je,we,Ne,ve,De,Ce,Fe,Se);function Te(){const{isAuthenticated:z}=fe("/register","/"),{loading:N,userAuth:k,userData:t,state:a,setState:u}=c.useContext(le),[g,q]=c.useState(0),[U,_]=c.useState([]),[J,Y]=c.useState([]),[H,W]=c.useState([]),[$,Z]=c.useState([]),[K,Q]=c.useState(0),[E,ee]=c.useState({}),[L,te]=c.useState({}),[h,O]=c.useState(!1);c.useEffect(()=>{var B;if(!t||!a.gastos||N)return;const s=parseInt((B=t==null?void 0:t.expenseControl)==null?void 0:B.cutoffDay,10)||12,n=new Date,d=n.getDate(),m=n.getMonth(),y=n.getFullYear(),p=new Date(y,m-(d<s?1:0),s),C=new Date(p.getFullYear(),p.getMonth()+1,s-1,23,59,59),j=a.gastos.filter(r=>{const l=r.createdAt instanceof Date?r.createdAt:r.createdAt.toDate();return l>=p&&l<=C}),T=j.reduce((r,l)=>(r[l.type]||(r[l.type]=0),r[l.type]+=parseFloat(l.gasto)||0,r),{}),w=j.reduce((r,l)=>(r[l.category]||(r[l.category]=0),r[l.category]+=parseFloat(l.gasto)||0,r),{}),F=Object.keys(T),o=Object.values(T),b=Object.keys(w),S=Object.values(w),I={labels:F,datasets:[{label:"Gastos por Tipo de Pago",data:o,backgroundColor:["#495867","#495867","#495867","#495867","#495867"],borderColor:"#fff",borderWidth:1}]};Y(o),W(F),Z(I),_(j),q(j.reduce((r,l)=>r+(parseFloat(l.gasto)||0),0)),te({labels:b,datasets:[{label:"Gastos por Categoría",data:S,backgroundColor:["#D3D6DB","#D3D6DB","#D3D6DB","#D3D6DB","#D3D6DB"],borderColor:"#fff",borderWidth:1}]});const i=a.ingresos.reduce((r,l)=>(r[l.category]||(r[l.category]=0),r[l.category]+=parseFloat(l.ingreso)||0,r),{}),A=Object.keys(i),P=Object.values(i);ee({labels:A,datasets:[{label:"Ingresos por Categoría",data:P,backgroundColor:["#D3D6DB","#D3D6DB","#D3D6DB","#D3D6DB","#D3D6DB"],borderColor:"#fff",borderWidth:1}]}),Q(a.ingresos.reduce((r,l)=>r+(parseFloat(l.ingreso)||0),0))},[a.gastos,t,N]),c.useEffect(()=>(a.isModalOpen?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[a.isModalOpen]);const G=()=>u(s=>({...s,isModalOpen:!0})),ae=()=>u(s=>({...s,isModalOpen:!1})),se=s=>{const n=s.replace(/[^0-9]/g,"");return n.length===0?"":(parseFloat(n)/100).toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})},f=s=>{const{name:n,type:d,value:m,files:y}=s.target;if(d==="file")u(p=>({...p,[n]:y[0]}));else{const p=n==="gasto"||n==="ingreso"?se(m):m;u(C=>({...C,[n]:p}))}},ne=s=>{const{name:n}=s.target,d=a[n].replace(/[^0-9]/g,""),m=d.length===0?"":parseFloat(d)/100;u(y=>({...y,[n]:m.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}))},re=async(s,n=!1)=>{var F;s.preventDefault(),u(o=>({...o,isSubmitting:!0}));const d=parseFloat((a[n?"ingreso":"gasto"]||"").toString().replace(/[^0-9.-]+/g,""));if(isNaN(d)||d<=0){u(o=>({...o,error:`Por favor, ingresa un ${n?"ingreso":"gasto"} válido.`,isSubmitting:!1})),console.log("ingreso");return}const m=a.date?new Date(a.date+"T00:00:00"):new Date,y=m.getFullYear(),p=m.getMonth(),C=m.getDate(),j=(t==null?void 0:t.expenseControl.cutoffDay)||1,T=String(y);let w="";C<j?w=["diciembreEnero","eneroFebrero","febreroMarzo","marzoAbril","abrilMayo","mayoJunio","junioJulio","julioAgosto","agostoSeptiembre","septiembreOctubre","octubreNoviembre","noviembreDiciembre"][p]||"desconocido":w=["eneroFebrero","febreroMarzo","marzoAbril","abrilMayo","mayoJunio","junioJulio","julioAgosto","agostoSeptiembre","septiembreOctubre","octubreNoviembre","noviembreDiciembre","diciembreEnero"][p]||"desconocido";try{let o=a.fileURL,b;if(a.file){const i=new Date,A=`${String(i.getFullYear()).slice(2)}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}`,P=`${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}${String(i.getSeconds()).padStart(2,"0")}`,B=a.file.name.replace(/[^a-zA-Z0-9.]/g,"_");b=`IMG_${A}-EC${P}.${B.split(".").pop()}`;const r=ce(de,`userFiles/${k.username}/${b}`);try{await me(r,a.file),o=await ue(r)}catch{throw new Error("No se pudo subir el archivo.")}}const S={[n?"ingreso":"gasto"]:d,title:a.title,remarks:a.remarks,type:a.type,category:a.category,user:k.username,createdAt:m,year:T,period:w};o&&(S.image={imageURL:o,name:b||((F=a.file)==null?void 0:F.name)||""});const I=n?"ingresos":"gastos";if(a.currentId){const i=pe(V,"userPosts",k.username,I,String(a.currentId));await xe(i,S)}else{const i=ge(V,"userPosts",k.username,I);await he(i,S)}u(i=>({...i,[n?"ingreso":"gasto"]:"",title:"",remarks:"",category:"",type:"",file:null,isModalOpen:!1,error:"",currentId:null})),setTimeout(()=>location.reload(),1e3)}catch(o){console.error(`Error al guardar el ${n?"ingreso":"gasto"}: `,o),u(b=>({...b,error:`Error al guardar los datos: ${o.message}`,isSubmitting:!1}))}finally{u(o=>({...o,isSubmitting:!1}))}},v=!N&&t&&t.expenseControl&&t.expenseControl.budget,M=!N&&t&&t.expenseControl&&t.expenseControl.budget-g,D=M*100/v,X=g*100/v;return a.loading?e.jsx(oe,{}):z?e.jsxs("div",{className:"mb-10",children:[e.jsxs("section",{className:"w-full max-w-screen-sm mt-6 py-3 flex flex-col items-center",children:[e.jsx("p",{className:"leading-3 text-main-dark/50",children:"Gastos Totales"}),e.jsxs("h1",{className:"text-4xl font-bold text-main-dark my-1",children:["$",g.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("p",{className:` ${v-g<0?"text-main-primary":"text-main-highlight"}`,children:new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(v-g.toFixed(2))})]}),e.jsxs("section",{className:"w-full max-w-screen-sm flex justify-between items-center gap-2 py-3",children:[e.jsxs("button",{onClick:()=>{O(!1),G()},className:"w-full flex-center gap-1 text-sm font-semibold bg-primary-nightshade/70 text-white rounded-3xl p-3 transition-colors duration-200 hover:bg-primary-nightshade",children:[e.jsx("i",{className:"flex-center w-6 h-6 rounded-full hover:scale-105",children:x.plus.fill("#FFFFFF")}),"Agregar Gasto"]}),e.jsxs("button",{onClick:()=>{O(!0),G()},className:"w-full flex-center gap-1 text-sm font-semibold bg-main-highlight/70 text-white rounded-3xl p-3 transition-colors duration-200 hover:bg-main-highlight",children:[e.jsx("i",{className:"flex-center w-6 h-6 rounded-full hover:scale-105",children:x.plus.fill("#FFFFFF")}),"Agregar Ingreso"]})]}),U.length>0&&e.jsxs("section",{className:"w-full max-w-screen-sm py-3",children:[e.jsx("h2",{className:"text-main-dark text-lg font-semibold mb-3",children:"Resumen Mensual"}),e.jsxs(ie,{to:"/expenses",className:"w-full flex gap-[4%] h-full rounded-3xl mb-3 bg-white",children:[e.jsxs("div",{className:"w-[48%] h-[130px] py-3 px-4 flex flex-col justify-between",children:[e.jsxs("p",{className:"w-full text-main-primary text-center flex gap-1 font-bold",children:[e.jsx("i",{className:"flex-center w-5 h-5 aspect-square",children:x.flame.fill("#C2185B")}),"Gastos"]}),e.jsxs("p",{className:`w-full font-semibold text-2xl mt-7 ${X>100&&"text-primary-nightshade"}`,children:[` ${X.toFixed(0)}% `,e.jsx("span",{className:"text-xs text-primary-slate/70",children:"gastado"})]})]}),e.jsx("div",{className:"w-[48%] h-[130px] max-h-[130px] p-4 rounded-3xl flex flex-col items-start",children:e.jsx("div",{className:"flex-grow flex-center w-full h-full pl-12",children:e.jsx(R,{data:L,options:{cutout:"55%",plugins:{tooltip:{callbacks:{label:s=>`${L.labels[s.dataIndex]}: $${L.datasets[0].data[s.dataIndex].toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}`}},legend:{display:!1}}}})})})]}),e.jsxs("aside",{className:"w-full flex gap-[4%] h-full rounded-3xl mb-3 bg-white",children:[e.jsxs("div",{className:"w-[48%] h-[130px] py-3 px-4 flex flex-col justify-between",children:[e.jsxs("p",{className:"w-full text-main-highlight/70 text-center flex gap-1 font-bold",children:[e.jsx("i",{className:"flex-center w-6 h-6",children:x.money.wings()}),"Ingresos"]}),e.jsxs("p",{className:"w-full font-semibold text-2xl mt-7",children:[`$${K.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}`,e.jsx("span",{className:"text-xs text-primary-slate/70",children:" ganados"})]})]}),e.jsx("div",{className:"w-[48%] h-[130px] max-h-[130px] p-4 rounded-3xl flex flex-col items-start",children:e.jsx("div",{className:"flex-grow flex-center w-full h-full pl-12",children:e.jsx(R,{data:E,options:{cutout:"55%",plugins:{tooltip:{callbacks:{label:s=>`${E.labels[s.dataIndex]}: $${E.datasets[0].data[s.dataIndex].toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}`}},legend:{display:!1}}}})})})]}),e.jsxs("aside",{className:"w-full flex flex-wrap items-stretch gap-[4%]",children:[e.jsxs("div",{className:`flex flex-col bg-white rounded-3xl py-3 px-4 ${D<0?" hidden ":" w-[48%] max-w-[300px]"}`,children:[e.jsx("span",{className:"font-light text-xs text-primary-slate",children:"Presupuesto Libre"}),e.jsxs("span",{className:"font-semibold text-xl text-main-dark",children:[" ",new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(v-g)]})]}),e.jsxs("div",{className:`flex flex-col bg-white rounded-3xl py-3 px-4 ${D<0?" items-start w-full":" w-[48%] max-w-[300px]"}`,children:[e.jsx("span",{className:"font-light text-xs text-primary-slate",children:"Gastos Totales"}),e.jsxs("span",{className:"font-semibold text-xl text-main-dark",children:["$",g.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]})]})]}),e.jsxs("aside",{className:"w-full flex flex-wrap items-stretch gap-[4%] mt-3",children:[e.jsxs("div",{className:`${M<0?"bg-primary-platinum":"bg-white hidden"} ${D<0?"w-[48%] max-w-[300px]":"w-full"} rounded-3xl p-4 flex justify-between items-center`,children:[e.jsx("span",{className:"text-main-dark",children:"Saldo"}),e.jsx("span",{className:`${M<0?"text-main-primary":"text-main-highlight"} font-semibold`,children:new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(M)})]}),D<0&&e.jsxs("div",{className:`w-[48%] max-w-[300px] bg-primary-platinum rounded-3xl p-4 flex items-center justify-between gap-1
                    opacity-0 transform scale-95 transition-all duration-500 ease-out motion-safe:animate-fade-in`,children:[e.jsx("i",{className:"flex-center w-6 h-6",children:x.alert.border("#C2185B")}),e.jsxs("span",{className:"text-sm text-main-primary",children:["Has gastado",e.jsx("span",{className:"text-base font-semibold text-main-primary",children:` ${D.toFixed(2)}% `}),"más de lo que deberías este mes."]})]})]}),e.jsx("aside",{className:"w-full flex flex-wrap items-start gap-[4%] my-3",children:H.map((s,n)=>e.jsx("div",{className:"w-[48%] max-w-[300px] mb-3",children:e.jsx("div",{className:"bg-white py-3 px-4 rounded-3xl h-full flex flex-col items-start",children:e.jsxs("div",{className:"flex-grow flex gap-4 w-full",children:[e.jsxs("p",{className:"flex flex-col items-start w-full",children:[e.jsxs("span",{className:"text-xs font-light capitalize text-main-dark",style:{color:$.datasets[0].backgroundColor[n]},children:[s==="card1"&&t.paymentTypes.card1,s==="card2"&&t.paymentTypes.card2,s==="card3"&&t.paymentTypes.card3,s==="card4"&&t.paymentTypes.card4,s==="card5"&&t.paymentTypes.card5,s==="other"&&t.paymentTypes.other,s==="cash"&&"Efectivo"]}),e.jsxs("span",{className:"text-xl font-semibold text-main-dark",children:["$",J[n].toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsx("i",{className:"flex-center w-9 h-9",children:s==="cash"&&x.money.border($.datasets[0].backgroundColor[n])||s==="other"&&x.bitcoin.border($.datasets[0].backgroundColor[n])||x.credit_card.border($.datasets[0].backgroundColor[n])})]})})},s))})]}),a.isModalOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full h-[85vh] relative overflow-hidden",children:e.jsxs("form",{onSubmit:s=>re(s,h),className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:ae,className:"p-2 text-main-primary",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:a.isSubmitting,className:"p-2 text-main-highlight rounded hover:bg-main-primary-dark transition",children:a.isSubmitting?"Guardando...":a.currentGastoId?"Actualizar":"Agregar"})]}),e.jsxs("div",{className:"px-2",children:[e.jsxs("hgroup",{className:"rounded-3xl py-2 px-4 mb-4 bg-main-light",children:[e.jsx("input",{name:"title",type:"text",placeholder:h?"Concepto del ingreso":"Concepto del gasto",value:a.title,onChange:f,className:"w-full py-2 bg-transparent outline-none border-b border-main-dark/20 text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsxs("div",{className:"flex-center pt-2 py-2",children:["$",e.jsx("input",{name:h?"ingreso":"gasto",type:"text",placeholder:`$ $ ${h?"Ingreso":"Gasto"}`,value:a[h?"ingreso":"gasto"],onChange:f,onBlur:ne,className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),!N&&t&&t.expenseControl&&(t==null?void 0:t.expenseControl.currency)]})]}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("select",{name:"type",value:a.type,onChange:f,className:"w-full bg-transparent outline-none",required:!0,children:h?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),t.incomeControl.paymentTypes.type1&&e.jsx("option",{value:"type1",children:t.incomeControl.paymentTypes.type1}),t.incomeControl.paymentTypes.type2&&e.jsx("option",{value:"type2",children:t.incomeControl.paymentTypes.type2}),t.incomeControl.paymentTypes.type3&&e.jsx("option",{value:"type3",children:t.incomeControl.paymentTypes.type3}),t.incomeControl.paymentTypes.type4&&e.jsx("option",{value:"type4",children:t.incomeControl.paymentTypes.type4}),t.incomeControl.paymentTypes.type5&&e.jsx("option",{value:"type5",children:t.incomeControl.paymentTypes.type5}),t.incomeControl.paymentTypes.other&&e.jsx("option",{value:"other",children:t.incomeControl.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]}):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),t.paymentTypes.card1&&e.jsx("option",{value:"card1",children:t.paymentTypes.card1}),t.paymentTypes.card2&&e.jsx("option",{value:"card2",children:t.paymentTypes.card2}),t.paymentTypes.card3&&e.jsx("option",{value:"card3",children:t.paymentTypes.card3}),t.paymentTypes.card4&&e.jsx("option",{value:"card4",children:t.paymentTypes.card4}),t.paymentTypes.card5&&e.jsx("option",{value:"card5",children:t.paymentTypes.card5}),t.paymentTypes.other&&e.jsx("option",{value:"other",children:t.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]})})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"category",value:a.category,onChange:f,className:"w-full bg-transparent outline-none",required:!0,children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Categorías"}),h?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"salary",children:"Salario"}),e.jsx("option",{value:"business",children:"Negocios"}),e.jsx("option",{value:"investment",children:"Inversiones"}),e.jsx("option",{value:"other",children:"Otros Ingresos"})]}):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"feeding",children:"Alimentación y Bebidas"}),e.jsx("option",{value:"transportation",children:"Transporte"}),e.jsx("option",{value:"health",children:"Salud y Bienestar"}),e.jsx("option",{value:"educationJob",children:"Gastos de Educación o Trabajo"}),e.jsx("option",{value:"housing",children:"Vivienda"}),e.jsx("option",{value:"entertainment",children:"Entretenimiento y Ocio"}),e.jsx("option",{value:"personalCare",children:"Ropa y Cuidado Personal"})]})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{id:"date",name:"date",type:"date",value:a.date,onChange:f,className:"w-full bg-transparent outline-none text-main-dark placeholder:text-main-dark/50"})}),!a.currentGastoId&&e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{name:"file",type:"file",onChange:f,className:"w-full",accept:"image/*, .pdf"})}),e.jsx("textarea",{name:"remarks",placeholder:"Observaciones",value:a.remarks,onChange:f,rows:"4",className:"w-full rounded-3xl p-4 mb-4 outline-none bg-main-light"})]})]})})})]}):null}export{Te as default};
