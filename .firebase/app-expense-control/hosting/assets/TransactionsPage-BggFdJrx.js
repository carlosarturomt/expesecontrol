import{r as x,U as z,j as e,S,I as D,d as k,a as j,g as J,b as q,c as X,s as _,u as Y,e as H,f as K,h as Q,i as W}from"./index-BIeWQ-q7.js";import{u as Z}from"./useAuthRequired-DFxz9pM2.js";import{F as ee,S as ae}from"./Button-DYFSwW0c.js";function le(){const{isLoading:T,isAuthenticated:E}=Z("/register","/transactions"),{loading:L,userAuth:p,userData:l,state:t,setState:u}=x.useContext(z),[te,A]=x.useState(0),[w,F]=x.useState(null),[se,G]=x.useState([]),[g,N]=x.useState("");x.useEffect(()=>{const a=t.gastos.reduce((s,n)=>s+(parseFloat(n.gasto)||0),0);A(a)},[t.gastos]),x.useEffect(()=>(t.isModalOpen?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[t.isModalOpen]);const v=t.gastos.filter(a=>a.title.toLowerCase().includes(g.toLowerCase())||a.remarks.toLowerCase().includes(g.toLowerCase())||a.category.toLowerCase().includes(g.toLowerCase())).sort((a,s)=>s.createdAt-a.createdAt),h=a=>{const s=a.target.value;s!==void 0&&N(s);let n=t.gastos;g&&(n=n.filter(o=>o.title.toLowerCase().includes(g.toLowerCase())||o.category.toLowerCase().includes(g.toLowerCase())||o.remarks.toLowerCase().includes(g.toLowerCase()))),s&&s!=="Todos"&&(n=n.filter(o=>o.category===s||s==="null"&&o.category==null)),G(n)},R=[{slug:h,label:"Todos",anchor:""},{slug:h,label:"Alimentación y Bebidas",anchor:"feeding"},{slug:h,label:"Transporte",anchor:"transportation"},{slug:h,label:"Salud y Bienestar",anchor:"health"},{slug:h,label:"Gastos de Educación o Trabajo",anchor:"educationJob"},{slug:h,label:"Vivienda",anchor:"housing"},{slug:h,label:"Entretenimiento y Ocio",anchor:"entertainment"},{slug:h,label:"Ropa y Cuidado Personal",anchor:"personalCare"}],M=a=>{F(w===a?null:a)},I=async(a,s,n)=>{try{const o=k(j,"userPosts",p.username,"gastos",a,s,n),c=await J(o);if(c.exists()){const i=c.data();u(f=>({...f,gasto:i.gasto||"",title:i.title||"",remarks:i.remarks||"",category:i.category||"",type:i.type||"",date:i.createdAt?i.createdAt.toDate().toISOString().substring(0,10):"",fileURL:i.fileURL||"",isModalOpen:!0,currentGastoId:n}))}else console.error("No se encontró el gasto para editar.")}catch(o){console.error("Error al obtener los datos del gasto:",o)}},O=async(a,s,n)=>{if(console.log(a,s,n),window.confirm(`¿Estás seguro de que deseas eliminar el gasto con ID: ${n}?`))try{const c=k(j,"userPosts",p.username,"gastos",a,s,n);await q(c),console.log(`Gasto con ID: ${n} eliminado.`)}catch(c){console.error("Error al eliminar el gasto: ",c)}},$=()=>u(a=>({...a,isModalOpen:!1})),B=a=>{const s=a.replace(/[^0-9]/g,"");return s.length===0?"":(parseFloat(s)/100).toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})},b=a=>{const{name:s,type:n,value:o,files:c}=a.target;if(n==="file")u(i=>({...i,[s]:c[0]}));else{const i=s==="gasto"?B(o):o;u(f=>({...f,[s]:i}))}},P=a=>{const{name:s}=a.target,n=t[s].replace(/[^0-9]/g,""),o=n.length===0?"":parseFloat(n)/100;u(c=>({...c,[s]:o.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}))},V=async a=>{a.preventDefault(),u(d=>({...d,isSubmitting:!0}));const s=parseFloat((t.gasto||"").toString().replace(/[^0-9.-]+/g,""));if(isNaN(s)||s<=0){u(d=>({...d,error:"Por favor, ingresa un gasto válido.",isSubmitting:!1}));return}const n=t.date?new Date(t.date+"T00:00:00"):new Date,o=n.getFullYear(),c=n.getMonth(),i=n.getDate(),f=p.cutoffDay||12,y=String(o);let r="";if(i<f)switch(c){case 0:r="diciembreEnero";break;case 1:r="eneroFebrero";break;case 2:r="febreroMarzo";break;case 3:r="marzoAbril";break;case 4:r="abrilMayo";break;case 5:r="mayoJunio";break;case 6:r="junioJulio";break;case 7:r="julioAgosto";break;case 8:r="agostoSeptiembre";break;case 9:r="septiembreOctubre";break;case 10:r="octubreNoviembre";break;case 11:r="noviembreDiciembre";break;default:r="desconocido"}else switch(c){case 0:r="eneroFebrero";break;case 1:r="febreroMarzo";break;case 2:r="marzoAbril";break;case 3:r="abrilMayo";break;case 4:r="mayoJunio";break;case 5:r="junioJulio";break;case 6:r="julioAgosto";break;case 7:r="agostoSeptiembre";break;case 8:r="septiembreOctubre";break;case 9:r="octubreNoviembre";break;case 10:r="noviembreDiciembre";break;case 11:r="diciembreEnero";break;default:r="desconocido"}try{let d=t.fileURL;if(t.file){const m=Date.now(),U=`${t.title}_${m}.${t.file.name.split(".").pop()}`,C=X(_,`userFiles/${p.username}/${U}`);await Y(C,t.file),d=await H(C)}if(t.currentGastoId){const m=k(j,"userPosts",p.username,"gastos",y,r,String(t.currentGastoId));await K(m,{gasto:s,title:t.title,remarks:t.remarks,type:t.type,category:t.category,fileURL:d,user:p.username,createdAt:n,year:y,period:r})}else{const m=Q(j,"userPosts",p.username,"gastos",y,r);await W(m,{gasto:s,title:t.title,remarks:t.remarks,type:t.type,category:t.category,fileURL:d,user:p.username,createdAt:n,year:y,period:r})}u(m=>({...m,gasto:"",title:"",remarks:"",category:"",type:"",file:null,isModalOpen:!1,error:"",currentGastoId:null}))}catch(d){console.error("Error al subir datos: ",d),u(m=>({...m,error:"Error al subir los datos: "+d.message,isSubmitting:!1}))}finally{u(d=>({...d,isSubmitting:!1}))}};return T?e.jsx(S,{bgTheme:!0}):E?e.jsxs("div",{children:[e.jsx("section",{className:"w-full max-w-screen-sm mt-6 py-3 flex flex-col items-center",children:e.jsx("p",{className:"text-main-dark/50",children:"Transacciones"})}),e.jsx("section",{className:"relative py-2 mb-2 flex items-center",children:e.jsxs("div",{className:"w-full flex-center pl-4 rounded-3xl bg-main-dark/5",children:[e.jsx("i",{className:"flex-center w-6 h-6 opacity-40",children:D.search.border("#1C1C1E")}),e.jsx("input",{type:"text",placeholder:"Filtrar gastos...",value:g,onChange:a=>N(a.target.value),className:"w-full h-full pl-1 py-4 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsx(ee,{label:e.jsx("i",{className:"flex-center w-6 h-6",children:D.filter.fill("#C2185B")}),items:R})]})}),e.jsxs("section",{className:"w-full max-w-screen-sm mb-20",children:[e.jsxs("hgroup",{className:"mb-4",children:[e.jsx("h2",{className:"text-main-dark py-2 text-lg font-semibold border-b border-main-dark/20",children:"Gastos"}),e.jsxs("p",{className:"py-2 text-sm font-light text-main-dark/50",children:[v.length," Resultados"]})]}),t.loading?e.jsx(S,{bgTheme:!0}):v.length>0?e.jsx("ul",{className:"space-y-3",children:v.sort((a,s)=>s.createdAt-a.createdAt).map(a=>e.jsx(ae,{context:l,data:a,onEdit:()=>I(a.year,a.period,a.id),onDelete:()=>O(a.year,a.period,a.id),expandedGastoId:w,onCardClick:M},a.id))}):e.jsx("li",{className:"flex justify-between items-center bg-main-dark/5 rounded-3xl p-4",children:e.jsx("span",{className:"text-main-dark font-medium",children:"No hay gastos registrados"})})]}),t.isModalOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full h-[85vh] relative overflow-hidden",children:e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:$,className:"p-2 text-main-primary",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:t.isSubmitting,className:"p-2 text-main-highlight rounded hover:bg-main-primary-dark transition",children:t.isSubmitting?"Guardando...":t.currentGastoId?"Actualizar":"Agregar"})]}),e.jsxs("div",{className:"px-2",children:[e.jsxs("hgroup",{className:"rounded-3xl py-2 px-4 mb-4 bg-main-light",children:[e.jsx("input",{name:"title",type:"text",placeholder:"Concepto",value:t.title,onChange:b,className:"w-full py-2 bg-transparent outline-none border-b border-main-dark/20 text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsxs("div",{className:"flex-center pt-2 py-2",children:["$",e.jsx("input",{name:"gasto",type:"text",placeholder:"$ $",value:t.gasto,onChange:b,onBlur:P,className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),!L&&(l==null?void 0:l.expenseControl.currency)]})]}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"type",value:t.type,onChange:b,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),l.paymentTypes.card1&&e.jsx("option",{value:"card1",children:l.paymentTypes.card1}),l.paymentTypes.card2&&e.jsx("option",{value:"card2",children:l.paymentTypes.card2}),l.paymentTypes.card3&&e.jsx("option",{value:"card3",children:l.paymentTypes.card3}),l.paymentTypes.card4&&e.jsx("option",{value:"card4",children:l.paymentTypes.card4}),l.paymentTypes.card5&&e.jsx("option",{value:"card5",children:l.paymentTypes.card5}),l.paymentTypes.other&&e.jsx("option",{value:"other",children:l.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"category",value:t.category,onChange:b,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Categorías"}),e.jsx("option",{value:"feeding",children:"Alimentación y Bebidas"}),e.jsx("option",{value:"transportation",children:"Transporte"}),e.jsx("option",{value:"health",children:"Salud y Bienestar"}),e.jsx("option",{value:"educationJob",children:"Gastos de Educación o Trabajo"}),e.jsx("option",{value:"housing",children:"Vivienda"}),e.jsx("option",{value:"entertainment",children:"Entretenimiento y Ocio"}),e.jsx("option",{value:"personalCare",children:"Ropa y Cuidado Personal"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{id:"date",name:"date",type:"date",value:t.date,onChange:b,className:"w-full bg-transparent outline-none text-main-dark placeholder:text-main-dark/50"})}),!t.currentGastoId&&e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{name:"file",type:"file",onChange:b,className:"w-full",accept:"image/*, .pdf"})}),e.jsx("textarea",{name:"remarks",placeholder:"Observaciones",value:t.remarks,onChange:b,rows:"4",className:"w-full rounded-3xl p-4 mb-4 outline-none bg-main-light"})]})]})})})]}):null}export{le as default};
