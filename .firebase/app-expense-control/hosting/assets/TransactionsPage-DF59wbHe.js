import{r as g,U as le,i as ie,j as e,I as m,e as F,d as E,k as ce,a as J,s as U,l as de,m as ue,b as me,g as pe,f as ge,c as be,h as he}from"./index-DE57Cpbo.js";import{f as _,g as z,C as ye,A as fe,p as xe,a as Ce,b as je,L as ke,c as we,d as ve,e as Ne,B as Se}from"./index-B3sN4ZPE.js";import{F as Te,S as Ee}from"./Button-B_wAcc2C.js";ye.register(fe,xe,Ce,je,ke,we,ve,Ne,Se);function Le(){const{loading:D,userAuth:f,userData:r,state:o,setState:b}=g.useContext(le),[j,L]=g.useState([]),[P,q]=g.useState({}),[S,G]=g.useState(null),[M,T]=g.useState("all"),[O,Y]=g.useState(null),[h,R]=g.useState(""),[X,W]=g.useState(0),[A,k]=g.useState(!0),[$,w]=g.useState(!0),[B,v]=g.useState(!0),{anchor:I}=ie(),H={card1:r&&r.paymentTypes&&r.paymentTypes.card1,card2:r&&r.paymentTypes&&r.paymentTypes.card2,card3:r&&r.paymentTypes&&r.paymentTypes.card3,card4:r&&r.paymentTypes&&r.paymentTypes.card4,card5:r&&r.paymentTypes&&r.paymentTypes.card5,other:r&&r.paymentTypes&&r.paymentTypes.other,cash:"Efectivo"};g.useEffect(()=>{switch(I){case"all":k(!0),w(!0),v(!0);break;case"gastos":k(!1),w(!1),v(!1);break;case"payments":k(!1),w(!1),v(!0);break;default:k(!0),w(!0),v(!0);break}},[I]),g.useEffect(()=>{var n;if(!r||!o.gastos||D)return;const a=parseInt((n=r==null?void 0:r.expenseControl)==null?void 0:n.cutoffDay,10)||12,l=new Date,c=l.getDate(),s=l.getMonth(),d=l.getFullYear();let u,p;switch(M){case"previous":u=new Date(d,s-1,a),p=new Date(d,s,a-1,23,59,59);break;case"year":u=new Date(d,0,1),p=new Date(d,11,31);break;case"all":L(o.gastos.filter(t=>t.title.toLowerCase().includes(h.toLowerCase())||t.remarks.toLowerCase().includes(h.toLowerCase())||t.category.toLowerCase().includes(h.toLowerCase())).sort((t,i)=>i.createdAt-t.createdAt));return;default:u=new Date(d,s-(c<a?1:0),a),p=new Date(u.getFullYear(),u.getMonth()+1,a-1,23,59,59)}const N=o.gastos.filter(t=>{const i=t.createdAt instanceof Date?t.createdAt:t.createdAt.toDate();return i>=u&&i<=p});W(N.reduce((t,i)=>t+(parseFloat(i.gasto)||0),0)),L(N.filter(t=>t.title.toLowerCase().includes(h.toLowerCase())||t.remarks.toLowerCase().includes(h.toLowerCase())||t.category.toLowerCase().includes(h.toLowerCase())).sort((t,i)=>i.createdAt-t.createdAt))},[o.gastos,r,M,D,h]),g.useEffect(()=>{if(j.length===0){G(null);return}const a=j.reduce((t,i)=>(t[i.category]||(t[i.category]=0),t[i.category]+=parseFloat(i.gasto)||0,t),{}),l={feeding:"Alimentación y Bebidas",transportation:"Transporte",health:"Salud y Bienestar",educationJob:"Educación o Trabajo",housing:"Vivienda",entertainment:"Entretenimiento y Ocio",personalCare:"Ropa y Cuidado Personal"},s={labels:Object.keys(a).map(t=>l[t]||t),datasets:[{label:"Gastos por Categoría",data:Object.values(a),backgroundColor:["rgba(255, 99, 132, 0.2)","rgba(255, 159, 64, 0.2)","rgba(255, 205, 86, 0.2)","rgba(75, 192, 192, 0.2)","rgba(54, 162, 235, 0.2)","rgba(153, 102, 255, 0.2)","rgba(201, 203, 207, 0.2)"],borderColor:["rgb(255, 99, 132)","rgb(255, 159, 64)","rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(54, 162, 235)","rgb(153, 102, 255)","rgb(201, 203, 207)"],borderWidth:1}]},d=j.reduce((t,i)=>(t[i.type]||(t[i.type]=0),t[i.type]+=parseFloat(i.gasto)||0,t),{}),u=Object.keys(d),p=Object.values(d),n={labels:u.map(t=>H[t]||t),datasets:[{label:"Gastos por Tipo de Pago",data:p,backgroundColor:["rgba(201, 203, 207, 0.2)","rgba(153, 102, 255, 0.2)","rgba(54, 162, 235, 0.2)","rgba(75, 192, 192, 0.2)","rgba(255, 205, 86, 0.2)","rgba(255, 159, 64, 0.2)","rgba(255, 99, 132, 0.2)"],borderColor:["rgb(201, 203, 207)","rgb(153, 102, 255)","rgb(54, 162, 235)","rgb(75, 192, 192)","rgb(255, 205, 86)","rgb(255, 159, 64)","rgb(255, 99, 132)"],borderWidth:1}]};q(n),G(s)},[j,h]);const K=async a=>{try{const l=F(E,"userPosts",f.username,"gastos",a),c=await ce(l);if(c.exists()){const s=c.data();b(d=>({...d,gasto:(s==null?void 0:s.gasto)||"",title:(s==null?void 0:s.title)||"",remarks:(s==null?void 0:s.remarks)||"",category:(s==null?void 0:s.category)||"",type:(s==null?void 0:s.type)||"",date:s!=null&&s.createdAt?s.createdAt.toDate().toISOString().substring(0,10):"",fileURL:(s==null?void 0:s.fileURL)||"",isModalOpen:!0,currentGastoId:a}))}else console.error(`El gasto con ID: ${a} no existe.`)}catch(l){console.error("Error al obtener los datos del gasto:",l)}},Q=async(a,l,c)=>{if(window.confirm(`¿Estás seguro de que deseas eliminar el gasto "${l.title}" de $${l.gasto}?`))try{const d=F(E,"userPosts",f.username,"gastos",a);if(c&&c.trim()!==""){const u=J(U,`userFiles/${f.username}/${c}`);try{await de(u),console.log("Imagen asociada eliminada de Storage.")}catch(p){console.error("Error al eliminar la imagen de Storage: ",p)}}else console.log("No se proporcionó una imagen para eliminar.");await ue(d),console.log("Gasto eliminado correctamente."),b(u=>({...u,gastos:u.gastos.filter(p=>p.id!==a)}))}catch(d){console.error("Error al eliminar el gasto: ",d),alert("No se pudo eliminar el gasto. Intenta nuevamente.")}},Z=a=>{Y(O===a?null:a)},y=a=>{a!==void 0&&R(a)},ee=[{slug:()=>T("all"),label:"Todos los gastos",icon:m.all.border("#1C1C1E")},{slug:()=>T("current"),label:"Periodo actual",icon:m.today.border("#1C1C1E")},{slug:()=>T("previous"),label:"Periodo anterior",icon:m.previous.border("#1C1C1E")},{slug:()=>T("year"),label:"Año actual",icon:m.calendar.border("#1C1C1E")}],ae=[{slug:()=>y(""),label:"Todas las categorías",anchor:"",icon:m.all.border("#1C1C1E")},{slug:()=>y("feeding"),label:"Alimentación y bebidas",anchor:"feeding",icon:m.restaurant.fill("#1C1C1E")},{slug:()=>y("transportation"),label:"Transporte",anchor:"transportation",icon:m.transportation.border("#1C1C1E")},{slug:()=>y("health"),label:"Salud y bienestar",anchor:"health",icon:m.care.border("#1C1C1E")},{slug:()=>y("educationJob"),label:"Educación o trabajo",anchor:"educationJob",icon:m.ruler.border("#1C1C1E")},{slug:()=>y("housing"),label:"Vivienda",anchor:"housing",icon:m.house.border("#1C1C1E")},{slug:()=>y("entertainment"),label:"Entretenimiento y ocio",anchor:"entertainment",icon:m.theater_masks.border("#1C1C1E")},{slug:()=>y("personalCare"),label:"Ropa y cuidado personal",anchor:"personalCare",icon:m.beauty.border("#1C1C1E")}],te=()=>b(a=>({...a,isModalOpen:!1})),re=a=>{const l=a.replace(/[^0-9]/g,"");return l.length===0?"":(parseFloat(l)/100).toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})},x=a=>{const{name:l,type:c,value:s,files:d}=a.target;if(c==="file")b(u=>({...u,[l]:d[0]}));else{const u=l==="gasto"?re(s):s;b(p=>({...p,[l]:u}))}},se=a=>{const{name:l}=a.target,c=o[l].replace(/[^0-9]/g,""),s=c.length===0?"":parseFloat(c)/100;b(d=>({...d,[l]:s.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}))},ne=async a=>{a.preventDefault(),b(t=>({...t,isSubmitting:!0}));const l=parseFloat((o.gasto||"").toString().replace(/[^0-9.-]+/g,""));if(isNaN(l)||l<=0){b(t=>({...t,error:"Por favor, ingresa un gasto válido.",isSubmitting:!1}));return}const c=o.date?new Date(o.date+"T00:00:00"):new Date,s=c.getFullYear(),d=c.getMonth(),u=c.getDate(),p=(r==null?void 0:r.expenseControl.cutoffDay)||1,N=String(s);let n="";if(u<p)switch(d){case 0:n="diciembreEnero";break;case 1:n="eneroFebrero";break;case 2:n="febreroMarzo";break;case 3:n="marzoAbril";break;case 4:n="abrilMayo";break;case 5:n="mayoJunio";break;case 6:n="junioJulio";break;case 7:n="julioAgosto";break;case 8:n="agostoSeptiembre";break;case 9:n="septiembreOctubre";break;case 10:n="octubreNoviembre";break;case 11:n="noviembreDiciembre";break;default:n="desconocido"}else switch(d){case 0:n="eneroFebrero";break;case 1:n="febreroMarzo";break;case 2:n="marzoAbril";break;case 3:n="abrilMayo";break;case 4:n="mayoJunio";break;case 5:n="junioJulio";break;case 6:n="julioAgosto";break;case 7:n="agostoSeptiembre";break;case 8:n="septiembreOctubre";break;case 9:n="octubreNoviembre";break;case 10:n="noviembreDiciembre";break;case 11:n="diciembreEnero";break;default:n="desconocido"}try{let t=o.fileURL;if(o.file){const C=Date.now(),oe=`${o.title}_${C}.${o.file.name.split(".").pop()}`,V=J(U,`userFiles/${f.username}/${oe}`);await me(V,o.file),t=await pe(V)}const i={gasto:l,title:o.title,remarks:o.remarks,type:o.type,category:o.category,user:f.username,createdAt:c,year:N,period:n};if(t&&(i.fileURL=t),o.currentGastoId){const C=F(E,"userPosts",f.username,"gastos",String(o.currentGastoId));await ge(C,i)}else{const C=be(E,"userPosts",f.username,"gastos");await he(C,i)}b(C=>({...C,gasto:"",title:"",remarks:"",category:"",type:"",file:null,isModalOpen:!1,error:"",currentGastoId:null})),setTimeout(()=>location.reload(),1e3)}catch(t){console.error("Error al subir datos: ",t),b(i=>({...i,error:"Error al subir los datos: "+t.message,isSubmitting:!1}))}finally{b(t=>({...t,isSubmitting:!1}))}};return e.jsxs("section",{className:"mx-auto p-4 mb-20",children:[e.jsxs("aside",{className:"py-2 mb-2 flex justify-center flex-col gap-2",children:[e.jsxs("div",{className:"w-full flex-center pl-4 rounded-3xl bg-main-dark/5",children:[e.jsx("i",{className:"flex-center w-6 h-6 opacity-40",children:m.search.border("#1C1C1E")}),e.jsx("input",{type:"text",placeholder:"Filtrar gastos...",value:h,onChange:a=>R(a.target.value),className:"w-full h-full pl-1 py-4 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsx(Te,{label:e.jsx("i",{className:"flex-center w-6 h-6",children:m.filter.fill("#00A86B")}),titleSectionOne:"Filtrar por periodo",itemsSectionOne:ee,titleSectionTwo:"Filtrar por categoría",itemsSectionTwo:ae})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>k(a=>!a),className:"flex-center w-10 h-10 p-2 rounded-full bg-main-highlight/70 text-main-light",children:A?m.chart.border("#F5F6FA"):m.chart_line.border("#F5F6FA")}),e.jsx("button",{onClick:()=>w(a=>!a),className:`w-fit flex-center gap-1 h-10 px-4 rounded-3xl ${$?"bg-main-highlight/70 text-main-light":"bg-main-dark/5 text-main-dark/50"}`,children:"Categoría"}),e.jsx("button",{onClick:()=>v(a=>!a),className:`w-fit flex-center gap-1 h-10 px-4 rounded-3xl ${B?"bg-main-highlight/70 text-main-light":"bg-main-dark/5 text-main-dark/50"}`,children:"Método de pago"})]})]}),e.jsxs("hgroup",{className:"mb-2",children:[e.jsx("h1",{className:"text-main-dark py-2 text-lg font-semibold border-b border-main-dark/20",children:"Detalles de Gastos"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"py-2 text-sm font-light text-main-dark/50",children:[j.length," Resultados"]}),e.jsxs("p",{className:"py-2 text-sm font-light text-main-dark/50",children:["$",X.toLocaleString("es-MX",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})," Gastados"]})]})]}),e.jsx("div",{className:"flex gap-4 mb-3",children:S?e.jsxs("div",{className:"w-full flex-center flex-col space-y-3",children:[$&&e.jsxs("div",{className:"w-full p-4 flex justify-center flex-col rounded-3xl bg-main-dark/5",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Gastos por categoría"}),A?e.jsx(_,{data:S,options:{indexAxis:"y",plugins:{legend:{display:!1}}}}):e.jsx(z,{data:S,options:{indexAxis:"y",plugins:{legend:{display:!1}}}})]}),B&&e.jsxs("div",{className:"w-full p-4 flex justify-center flex-col rounded-3xl bg-main-dark/5",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Gastos por tipo de pago"}),A?e.jsx(_,{data:P,options:{plugins:{legend:{display:!1}}}}):e.jsx(z,{data:P,options:{plugins:{legend:{display:!1}}}})]})]}):S==null?e.jsx("p",{className:"text-center text-gray-500",children:"Sin resultados"}):e.jsx("p",{className:"text-center text-gray-500",children:"Cargando gráficos..."})}),e.jsx("ul",{className:"space-y-3",children:j.sort((a,l)=>{const c=a.createdAt instanceof Date?a.createdAt:new Date(a.createdAt);return(l.createdAt instanceof Date?l.createdAt:new Date(l.createdAt))-c}).map(a=>e.jsx(Ee,{context:r,data:a,onEdit:()=>K(a.id),onDelete:()=>Q(a.id,a,a.image&&a.image.name),expandedGastoId:O,onCardClick:Z},a.id))}),o.isModalOpen&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg max-w-lg w-full h-[85vh] relative overflow-hidden",children:e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:te,className:"p-2 text-main-primary",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:o.isSubmitting,className:"p-2 text-main-highlight rounded hover:bg-main-primary-dark transition",children:o.isSubmitting?"Guardando...":o.currentGastoId?"Actualizar":"Agregar"})]}),e.jsxs("div",{className:"px-2",children:[e.jsxs("hgroup",{className:"rounded-3xl py-2 px-4 mb-4 bg-main-light",children:[e.jsx("input",{name:"title",type:"text",placeholder:"Concepto",value:o.title,onChange:x,className:"w-full py-2 bg-transparent outline-none border-b border-main-dark/20 text-main-dark placeholder:text-main-dark/50",required:!0}),e.jsxs("div",{className:"flex-center pt-2 py-2",children:["$",e.jsx("input",{name:"gasto",type:"text",placeholder:"$ $",value:o.gasto,onChange:x,onBlur:se,className:"w-full pl-1 bg-transparent outline-none text-main-dark placeholder:text-main-dark/50",required:!0}),!D&&(r==null?void 0:r.expenseControl.currency)]})]}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"type",value:o.type,onChange:x,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Pago con"}),r.paymentTypes.card1&&e.jsx("option",{value:"card1",children:r.paymentTypes.card1}),r.paymentTypes.card2&&e.jsx("option",{value:"card2",children:r.paymentTypes.card2}),r.paymentTypes.card3&&e.jsx("option",{value:"card3",children:r.paymentTypes.card3}),r.paymentTypes.card4&&e.jsx("option",{value:"card4",children:r.paymentTypes.card4}),r.paymentTypes.card5&&e.jsx("option",{value:"card5",children:r.paymentTypes.card5}),r.paymentTypes.other&&e.jsx("option",{value:"other",children:r.paymentTypes.other}),e.jsx("option",{value:"cash",children:"Efectivo"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsxs("select",{name:"category",value:o.category,onChange:x,className:"w-full bg-transparent outline-none",children:[e.jsx("option",{value:"",hidden:!0,className:"text-main-gray",children:"Categorías"}),e.jsx("option",{value:"feeding",children:"Alimentación y Bebidas"}),e.jsx("option",{value:"transportation",children:"Transporte"}),e.jsx("option",{value:"health",children:"Salud y Bienestar"}),e.jsx("option",{value:"educationJob",children:"Educación o Trabajo"}),e.jsx("option",{value:"housing",children:"Vivienda"}),e.jsx("option",{value:"entertainment",children:"Entretenimiento y Ocio"}),e.jsx("option",{value:"personalCare",children:"Ropa y Cuidado Personal"})]})}),e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{id:"date",name:"date",type:"date",value:o.date,onChange:x,className:"w-full bg-transparent outline-none text-main-dark placeholder:text-main-dark/50"})}),!o.currentGastoId&&e.jsx("div",{className:"rounded-3xl p-4 mb-4 bg-main-light",children:e.jsx("input",{name:"file",type:"file",onChange:x,className:"w-full",accept:"image/*, .pdf"})}),e.jsx("textarea",{name:"remarks",placeholder:"Observaciones",value:o.remarks,onChange:x,rows:"4",className:"w-full rounded-3xl p-4 mb-4 outline-none bg-main-light"})]})]})})})]})}export{Le as default};
